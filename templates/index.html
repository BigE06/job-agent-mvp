<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Agent | AI Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    * {
      font-family: 'Inter', sans-serif;
    }

    .card-hover {
      transition: all 0.2s ease;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    }

    .modal-backdrop {
      backdrop-filter: blur(4px);
    }

    .btn-loading {
      pointer-events: none;
      opacity: 0.7;
    }

    .cv-preview {
      font-family: 'Times New Roman', serif;
    }

    .status-badge {
      transition: all 0.15s ease;
    }

    .drop-zone {
      transition: all 0.2s ease;
    }

    .drop-zone:hover {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }

    .drop-zone.dragover {
      border-color: #3b82f6;
      background-color: #dbeafe;
    }

    .tab-active {
      border-bottom: 2px solid #3b82f6;
      color: #3b82f6;
    }

    .tab-inactive {
      border-bottom: 2px solid transparent;
      color: #6b7280;
    }

    .tab-inactive:hover {
      color: #374151;
    }

    /* Heart button styles */
    .heart-btn {
      transition: all 0.2s ease;
    }

    .heart-btn:hover {
      transform: scale(1.1);
    }

    .heart-btn.saved {
      color: #ef4444;
    }

    /* Kanban column styles */
    .kanban-column {
      min-height: 400px;
    }

    .kanban-card {
      transition: all 0.15s ease;
    }

    .kanban-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .move-btn {
      transition: all 0.15s ease;
    }

    /* Futuristic Interview UI Animations */
    @keyframes orb-glow {

      0%,
      100% {
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.3), 0 0 40px rgba(139, 92, 246, 0.2), 0 0 60px rgba(139, 92, 246, 0.1);
        transform: scale(1);
      }

      50% {
        box-shadow: 0 0 40px rgba(139, 92, 246, 0.5), 0 0 80px rgba(139, 92, 246, 0.3), 0 0 120px rgba(139, 92, 246, 0.2);
        transform: scale(1.05);
      }
    }

    .orb-speaking {
      animation: orb-glow 1.5s ease-in-out infinite;
    }

    @keyframes sound-wave {

      0%,
      100% {
        height: 8px;
      }

      50% {
        height: 24px;
      }
    }

    .wave-bar {
      width: 4px;
      background: linear-gradient(to top, #8b5cf6, #c4b5fd);
      border-radius: 2px;
      animation: sound-wave 0.8s ease-in-out infinite;
    }

    .wave-bar:nth-child(1) {
      animation-delay: 0s;
    }

    .wave-bar:nth-child(2) {
      animation-delay: 0.1s;
    }

    .wave-bar:nth-child(3) {
      animation-delay: 0.2s;
    }

    .wave-bar:nth-child(4) {
      animation-delay: 0.3s;
    }

    .wave-bar:nth-child(5) {
      animation-delay: 0.4s;
    }

    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fade-in 0.5s ease-out forwards;
    }

    .move-btn:hover:not(:disabled) {
      background-color: #e5e7eb;
    }

    .move-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div
            class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl flex items-center justify-center">
            <i class="fas fa-bolt text-white"></i>
          </div>
          <span class="text-xl font-bold text-gray-900">JobAgent</span>
        </div>
        <div class="flex items-center space-x-3">
          <button onclick="loadJobs()" class="px-3 py-2 text-gray-600 hover:text-gray-900 text-sm">
            <i class="fas fa-sync-alt mr-1"></i> Refresh
          </button>
          <a href="/logout" class="px-3 py-2 text-gray-500 hover:text-gray-700 text-sm">
            <i class="fas fa-sign-out-alt mr-1"></i> Logout
          </a>
          <button id="profile-btn" onclick="openProfileModal()"
            class="px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200 flex items-center">
            <i class="fas fa-user mr-2"></i>
            <span id="user-display">Profile</span>
          </button>
        </div>
      </div>

      <!-- Search Bar Row -->
      <div class="mt-4 flex flex-col sm:flex-row gap-3">
        <div class="flex-1 relative">
          <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
          <input type="text" id="search-query" placeholder="Search roles... (e.g., AI Engineer)"
            class="w-full pl-11 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
            onkeydown="if(event.key==='Enter') triggerScrape()">
        </div>
        <div class="sm:w-56 relative">
          <i class="fas fa-map-marker-alt absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
          <input type="text" id="search-location" placeholder="Location... (e.g., NYC)"
            class="w-full pl-11 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
            onkeydown="if(event.key==='Enter') triggerScrape()">
        </div>
        <button onclick="triggerScrape()" id="search-btn"
          class="px-6 py-3 bg-blue-600 text-white text-sm font-medium rounded-xl hover:bg-blue-700 transition flex items-center justify-center">
          <i class="fas fa-search mr-2"></i> Search
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-6 py-6">

    <!-- Tabs -->
    <div class="flex items-center space-x-6 border-b border-gray-200 mb-6">
      <button id="tab-feed" onclick="switchTab('feed')" class="pb-3 px-1 font-medium text-sm tab-active">
        <i class="fas fa-rss mr-2"></i> Job Feed
      </button>
      <button id="tab-kanban" onclick="switchTab('kanban')" class="pb-3 px-1 font-medium text-sm tab-inactive">
        <i class="fas fa-columns mr-2"></i> My Applications
      </button>
    </div>

    <!-- Stats Bar -->
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h1 id="page-title" class="text-2xl font-bold text-gray-900">Job Feed</h1>
        <p id="job-count" class="text-gray-500 text-sm">Loading jobs...</p>
      </div>
      <div id="profile-status" class="flex items-center space-x-2 text-sm">
        <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full">
          <i class="fas fa-exclamation-circle mr-1"></i> No Resume
        </span>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-16">
      <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
      <p class="text-gray-500">Loading jobs...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden text-center py-16">
      <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
      <p class="text-gray-700 font-medium">Failed to load jobs</p>
      <p id="error-message" class="text-gray-500 text-sm mt-2"></p>
      <button onclick="loadJobs()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg">Try Again</button>
    </div>

    <!-- Jobs Grid (Job Feed Tab) -->
    <div id="jobs-container" class="hidden grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
      <!-- Jobs inserted here -->
    </div>

    <!-- Kanban Board (My Applications Tab) -->
    <div id="kanban-container" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Saved Column -->
        <div class="kanban-column bg-gray-100 rounded-xl p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-700 flex items-center">
              <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
              Saved
            </h3>
            <span id="saved-count" class="text-xs bg-gray-300 text-gray-700 px-2 py-0.5 rounded-full">0</span>
          </div>
          <div id="kanban-saved" class="space-y-3">
            <!-- Saved jobs here -->
          </div>
        </div>

        <!-- Applied Column -->
        <div class="kanban-column bg-blue-50 rounded-xl p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-blue-700 flex items-center">
              <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
              Applied
            </h3>
            <span id="applied-count" class="text-xs bg-blue-200 text-blue-700 px-2 py-0.5 rounded-full">0</span>
          </div>
          <div id="kanban-applied" class="space-y-3">
            <!-- Applied jobs here -->
          </div>
        </div>

        <!-- Interview Column -->
        <div class="kanban-column bg-purple-50 rounded-xl p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-purple-700 flex items-center">
              <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
              Interview
            </h3>
            <span id="interview-count" class="text-xs bg-purple-200 text-purple-700 px-2 py-0.5 rounded-full">0</span>
          </div>
          <div id="kanban-interview" class="space-y-3">
            <!-- Interview jobs here -->
          </div>
        </div>

        <!-- Offer Column -->
        <div class="kanban-column bg-green-50 rounded-xl p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-green-700 flex items-center">
              <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
              Offer
            </h3>
            <span id="offer-count" class="text-xs bg-green-200 text-green-700 px-2 py-0.5 rounded-full">0</span>
          </div>
          <div id="kanban-offer" class="space-y-3">
            <!-- Offer jobs here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty" class="hidden text-center py-16">
      <i class="fas fa-briefcase text-4xl text-gray-300 mb-4"></i>
      <p class="text-gray-700 font-medium" id="empty-title">No jobs found</p>
      <p class="text-gray-500 text-sm mt-2" id="empty-subtitle">Use the search bar above to find jobs</p>
    </div>
  </main>

  <!-- ======================== -->
  <!-- PROFILE MODAL -->
  <!-- ======================== -->
  <div id="profile-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0 bg-black/40" onclick="closeProfileModal()"></div>
    <div
      class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
      <div class="flex items-center justify-between p-6 border-b">
        <h2 class="text-xl font-bold text-gray-900">Your Profile</h2>
        <button onclick="closeProfileModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="p-6 max-h-[70vh] overflow-y-auto">

        <!-- PDF Upload Drop Zone -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Upload Resume (PDF)</label>
          <div id="drop-zone"
            class="drop-zone border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer bg-gray-50"
            onclick="document.getElementById('pdf-input').click()">
            <input type="file" id="pdf-input" accept=".pdf" class="hidden" onchange="handlePdfUpload(event)">
            <div id="drop-zone-content">
              <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
              <p class="text-gray-600 font-medium text-sm">Click to upload or drag & drop</p>
              <p class="text-gray-400 text-xs mt-1">PDF files only (max 5MB)</p>
            </div>
            <div id="drop-zone-loading" class="hidden">
              <i class="fas fa-spinner fa-spin text-3xl text-blue-500 mb-2"></i>
              <p class="text-blue-600 font-medium text-sm">Parsing PDF...</p>
            </div>
            <div id="drop-zone-success" class="hidden">
              <i class="fas fa-check-circle text-3xl text-green-500 mb-2"></i>
              <p class="text-green-600 font-medium text-sm">Resume parsed!</p>
              <p id="pdf-filename" class="text-gray-500 text-xs mt-1"></p>
            </div>
          </div>
        </div>

        <!-- Resume Text -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Resume Text</label>
          <textarea id="profile-resume" rows="8"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm max-h-48 overflow-y-auto"
            placeholder="Your resume text will appear here..."></textarea>
        </div>

        <!-- Skills with scroll -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Key Skills (comma-separated)</label>
          <textarea id="profile-skills" rows="2"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm max-h-24 overflow-y-auto"
            placeholder="Python, Machine Learning, FastAPI, SQL..."></textarea>
        </div>
      </div>
      <div class="flex justify-end p-6 border-t bg-gray-50">
        <button onclick="closeProfileModal()" class="px-4 py-2 text-gray-600 mr-3">Cancel</button>
        <button onclick="saveProfile()"
          class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">
          <i class="fas fa-save mr-2"></i> Save
        </button>
      </div>
    </div>
  </div>

  <!-- ======================== -->
  <!-- ONBOARDING MODAL (Welcome Wizard) -->
  <!-- ======================== -->
  <div id="onboarding-modal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full overflow-hidden">
        <!-- Header with gradient -->
        <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 p-8 text-center">
          <div class="w-20 h-20 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-rocket text-white text-3xl"></i>
          </div>
          <h2 class="text-2xl font-bold text-white">Welcome to your Career Copilot! ðŸš€</h2>
        </div>

        <!-- Body -->
        <div class="p-6">
          <p class="text-gray-600 text-center mb-6 leading-relaxed">
            To generate <span class="font-semibold text-gray-900">tailored CVs</span> and get
            <span class="font-semibold text-gray-900">ATS Match Scores</span>, we need your baseline resume.
            <br><span class="text-sm text-gray-500">It takes 10 seconds.</span>
          </p>

          <!-- Benefits list -->
          <div class="space-y-3 mb-6">
            <div class="flex items-center gap-3 text-sm">
              <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-check text-green-600"></i>
              </div>
              <span class="text-gray-700">1-Click tailored CVs for every job</span>
            </div>
            <div class="flex items-center gap-3 text-sm">
              <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-chart-pie text-blue-600"></i>
              </div>
              <span class="text-gray-700">Instant ATS Match Scores</span>
            </div>
            <div class="flex items-center gap-3 text-sm">
              <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-microphone text-purple-600"></i>
              </div>
              <span class="text-gray-700">AI Interview Prep with feedback</span>
            </div>
          </div>

          <!-- CTA Button with ID for event binding -->
          <button id="btn-upload-modal"
            class="w-full py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition flex items-center justify-center gap-2">
            <i class="fas fa-upload"></i>
            <span id="btn-upload-modal-text">Upload Resume Now</span>
          </button>

          <!-- Hidden file input for onboarding modal -->
          <input type="file" id="onboarding-resume-input" accept=".pdf" class="hidden">

          <p class="text-center text-gray-400 text-xs mt-4">You can always update your profile later</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ======================== -->
  <!-- RESULT MODAL -->
  <!-- ======================== -->
  <div id="result-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0 bg-black/40" onclick="closeResultModal()"></div>
    <div
      class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-3xl bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
      <div class="flex items-center justify-between p-6 border-b shrink-0">
        <h2 id="result-title" class="text-xl font-bold text-gray-900">Result</h2>
        <button onclick="closeResultModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div id="result-content" class="p-6 overflow-y-auto flex-1">
        <!-- Dynamic content -->
      </div>
      <!-- Sticky Footer with Verify Button -->
      <div class="flex justify-between items-center p-4 border-t bg-gray-50 shrink-0 rounded-b-2xl">
        <!-- Left: Verify Score Button (hidden by default, shown for CV results) -->
        <div id="footer-verify-container" class="hidden">
          <button id="btn-verify-score-footer"
            class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold rounded-lg shadow hover:shadow-lg hover:from-purple-700 hover:to-indigo-700 transition-all flex items-center gap-2">
            <i class="fas fa-bolt"></i>
            <span id="btn-verify-text-footer">Check ATS Score</span>
          </button>
        </div>
        <!-- Spacer when verify button is hidden -->
        <div id="footer-spacer" class="flex-1"></div>

        <!-- Right: Copy and Done -->
        <div class="flex gap-3">
          <button onclick="copyResultToClipboard()"
            class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg border border-gray-200 flex items-center gap-2">
            <i class="fas fa-copy"></i> Copy
          </button>
          <button onclick="closeResultModal()"
            class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">Done</button>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- ======================== -->
  <!-- FUTURISTIC VOICE INTERVIEW MODAL -->
  <!-- ======================== -->
  <div id="interview-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-white"></div>
    <div class="absolute inset-0 flex flex-col">

      <!-- Header Bar -->
      <div class="flex items-center justify-between px-6 py-4 border-b bg-white shrink-0">
        <div>
          <span class="text-xs text-purple-600 font-semibold tracking-wider uppercase">AI Interview</span>
          <h2 id="interview-job-title" class="text-lg font-bold text-gray-900"></h2>
        </div>
        <div class="flex items-center gap-4">
          <span id="interview-counter" class="text-sm text-gray-500">Question 1 of 5</span>
          <button onclick="closeInterviewModal()" class="text-gray-400 hover:text-gray-600 p-2">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="flex-1 flex flex-col items-center justify-center p-8">

        <!-- Void Orb (Pure CSS, no icons) -->
        <div id="ai-orb"
          class="w-32 h-32 bg-black rounded-full mx-auto flex items-center justify-center mb-8 shadow-2xl relative">
          <div class="absolute w-full h-full bg-black rounded-full animate-ping opacity-20"></div>
        </div>

        <!-- Question Display -->
        <div id="interview-question-area" class="text-center max-w-2xl mb-8">
          <p id="interview-question" class="text-xl text-gray-800 leading-relaxed font-medium fade-in"></p>
        </div>

        <!-- Sound Wave (shown when listening) -->
        <div id="sound-wave" class="hidden flex items-center justify-center gap-1 h-8 mb-6">
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
          <div class="wave-bar"></div>
        </div>

        <!-- Status Text -->
        <p id="interview-status" class="text-sm text-gray-500 mb-8">AI is speaking...</p>

        <!-- Action Buttons -->
        <div id="interview-actions" class="flex flex-col items-center gap-4">

          <!-- Tap to Answer Button (shown after AI speaks) -->
          <button id="btn-start-recording" onclick="startRecording()"
            class="hidden px-8 py-4 bg-purple-600 text-white font-semibold rounded-full hover:bg-purple-700 transition flex items-center gap-3 shadow-lg hover:shadow-xl">
            <i class="fas fa-microphone text-xl"></i>
            Tap to Answer
          </button>

          <!-- Stop Recording Button -->
          <button id="btn-stop-recording" onclick="stopRecording()"
            class="hidden px-8 py-4 bg-red-500 text-white font-semibold rounded-full hover:bg-red-600 transition flex items-center gap-3 shadow-lg">
            <i class="fas fa-stop text-xl"></i>
            Done Speaking
          </button>

          <!-- Processing Indicator -->
          <div id="interview-processing" class="hidden flex items-center gap-2 text-purple-600">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Processing your answer...</span>
          </div>
        </div>
      </div>

      <!-- Interview Complete Screen (hidden by default) -->
      <div id="interview-complete"
        class="hidden absolute inset-0 bg-white flex flex-col items-center justify-center p-8">
        <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6">
          <i class="fas fa-check text-4xl text-green-600"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-900 mb-2">Interview Complete!</h3>
        <p class="text-gray-500 mb-8">Great job practicing your responses.</p>
        <div class="flex gap-4">
          <button onclick="generateInterviewAnalysis()"
            class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition">
            <i class="fas fa-chart-line mr-2"></i> Generate Analysis
          </button>
          <button onclick="closeInterviewModal()"
            class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">
            Close
          </button>
        </div>
      </div>

    </div>
  </div>

  <script>
    // =============================================
    // JOB AGENT DASHBOARD 3.0 - HEART/KANBAN
    // =============================================

    let allJobs = [];
    let savedJobs = [];  // Separate array for saved jobs (from /api/saved-jobs)
    let savedJobsMap = new Map();  // Map URL -> saved job ID for toggle state
    let currentTab = 'feed';
    let currentResultText = '';

    // Kanban statuses in order (for move left/right)
    const KANBAN_STATUSES = ['saved', 'applied', 'interview', 'offer'];

    // --- Salary Formatter ---
    function formatSalary(min, max) {
      if (!min && !max) return null;

      const minVal = parseInt(min) || 0;
      const maxVal = parseInt(max) || 0;

      const format = (val) => {
        if (val >= 1000) {
          return `$${Math.round(val / 1000)}K`;
        }
        return `$${val}`;
      };

      if (!minVal && maxVal) return format(maxVal);
      if (minVal && !maxVal) return format(minVal);
      if (minVal === maxVal) return format(minVal);

      return `${format(minVal)} - ${format(maxVal)}`;
    }

    // --- Tab Switching ---
    function switchTab(tab) {
      currentTab = tab;

      // Update tab UI
      document.getElementById('tab-feed').className = tab === 'feed'
        ? 'pb-3 px-1 font-medium text-sm tab-active'
        : 'pb-3 px-1 font-medium text-sm tab-inactive';
      document.getElementById('tab-kanban').className = tab === 'kanban'
        ? 'pb-3 px-1 font-medium text-sm tab-active'
        : 'pb-3 px-1 font-medium text-sm tab-inactive';

      // Update title
      document.getElementById('page-title').textContent = tab === 'feed'
        ? 'Job Feed'
        : 'My Applications';

      // Toggle containers
      const jobsContainer = document.getElementById('jobs-container');
      const kanbanContainer = document.getElementById('kanban-container');
      const empty = document.getElementById('empty');

      if (tab === 'feed') {
        kanbanContainer.classList.add('hidden');
        renderJobs();
      } else {
        // Kanban: Fetch saved jobs from DB (source of truth)
        jobsContainer.classList.add('hidden');
        empty.classList.add('hidden');
        loadSavedJobs();
      }
    }

    // --- Load Jobs (Feed) ---
    async function loadJobs() {
      console.log('ðŸ” Fetching jobs...');
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const container = document.getElementById('jobs-container');
      const kanbanContainer = document.getElementById('kanban-container');
      const empty = document.getElementById('empty');

      loading.classList.remove('hidden');
      error.classList.add('hidden');
      container.classList.add('hidden');
      kanbanContainer.classList.add('hidden');
      empty.classList.add('hidden');

      try {
        // Load feed jobs AND saved jobs map in parallel
        const [feedRes, savedRes] = await Promise.all([
          fetch('/jobs'),
          fetch('/api/saved-jobs')
        ]);

        if (!feedRes.ok) throw new Error(`Feed: HTTP ${feedRes.status}`);

        const jobs = await feedRes.json();
        console.log('âœ… Loaded feed jobs:', jobs.length);
        allJobs = Array.isArray(jobs) ? jobs : [];

        // Build savedJobsMap from saved jobs (URL -> ID)
        if (savedRes.ok) {
          const savedData = await savedRes.json();
          savedJobs = savedData.jobs || [];
          savedJobsMap.clear();
          savedJobs.forEach(job => {
            const url = job.url || job.link || '';
            if (url) savedJobsMap.set(url, job.id);
          });
          console.log('âœ… Loaded saved jobs map:', savedJobsMap.size);
        }

        loading.classList.add('hidden');

        if (currentTab === 'feed') {
          renderJobs();
        } else {
          renderKanban();
        }

      } catch (err) {
        console.error('âŒ', err);
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        document.getElementById('error-message').textContent = err.message;
      }
    }

    // --- Load Saved Jobs (Kanban - from DB) ---
    async function loadSavedJobs() {
      const kanbanContainer = document.getElementById('kanban-container');
      const countEl = document.getElementById('job-count');

      countEl.textContent = 'Loading...';

      try {
        const res = await fetch('/api/saved-jobs');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        savedJobs = data.jobs || [];
        console.log('âœ… Loaded saved jobs:', savedJobs.length);

        // Update savedJobsMap
        savedJobsMap.clear();
        savedJobs.forEach(job => {
          const url = job.url || job.link || '';
          if (url) savedJobsMap.set(url, job.id);
        });

        renderKanban();

      } catch (err) {
        console.error('âŒ Failed to load saved jobs:', err);
        countEl.textContent = 'Error loading';
      }
    }

    // --- Render Jobs (Job Feed - Only Unsaved Jobs) ---
    function renderJobs() {
      const container = document.getElementById('jobs-container');
      const empty = document.getElementById('empty');
      const countEl = document.getElementById('job-count');

      // Job Feed: Show only jobs with status 'new' or no status
      const feedJobs = allJobs.filter(job => !job.status || job.status.toLowerCase() === 'new');

      if (feedJobs.length === 0) {
        container.classList.add('hidden');
        empty.classList.remove('hidden');
        document.getElementById('empty-title').textContent = 'No new jobs found';
        document.getElementById('empty-subtitle').textContent = 'Use the search bar above to find jobs';
        countEl.textContent = '0 jobs';
        return;
      }

      container.innerHTML = feedJobs.map((job) => createFeedCard(job)).join('');
      container.classList.remove('hidden');
      empty.classList.add('hidden');
      countEl.textContent = `${feedJobs.length} job${feedJobs.length !== 1 ? 's' : ''}`;
    }

    // --- Render Kanban Board (uses savedJobs from API) ---
    function renderKanban() {
      const kanbanContainer = document.getElementById('kanban-container');
      const empty = document.getElementById('empty');
      const countEl = document.getElementById('job-count');

      // Group saved jobs by status (use savedJobs array, not allJobs)
      const statusSaved = savedJobs.filter(j => {
        const status = (j.status || 'Saved').toLowerCase();
        return status === 'saved';
      });
      const statusApplied = savedJobs.filter(j => {
        const status = (j.status || '').toLowerCase();
        return status === 'applied';
      });
      const statusInterview = savedJobs.filter(j => {
        const status = (j.status || '').toLowerCase();
        return status === 'interview' || status === 'interviewing';
      });
      const statusOffer = savedJobs.filter(j => {
        const status = (j.status || '').toLowerCase();
        return status === 'offer';
      });

      const totalTracked = savedJobs.length;

      if (totalTracked === 0) {
        kanbanContainer.classList.add('hidden');
        empty.classList.remove('hidden');
        document.getElementById('empty-title').textContent = 'No saved applications yet';
        document.getElementById('empty-subtitle').textContent = 'Click the â¤ï¸ heart on a job card to start tracking';
        countEl.textContent = '0 tracked';
        return;
      }

      // Populate columns
      document.getElementById('kanban-saved').innerHTML = statusSaved.map(j => createKanbanCard(j, 0)).join('') || '<p class="text-gray-400 text-sm text-center py-4">No jobs</p>';
      document.getElementById('kanban-applied').innerHTML = statusApplied.map(j => createKanbanCard(j, 1)).join('') || '<p class="text-gray-400 text-sm text-center py-4">No jobs</p>';
      document.getElementById('kanban-interview').innerHTML = statusInterview.map(j => createKanbanCard(j, 2)).join('') || '<p class="text-gray-400 text-sm text-center py-4">No jobs</p>';
      document.getElementById('kanban-offer').innerHTML = statusOffer.map(j => createKanbanCard(j, 3)).join('') || '<p class="text-gray-400 text-sm text-center py-4">No jobs</p>';

      // Update counts
      document.getElementById('saved-count').textContent = statusSaved.length;
      document.getElementById('applied-count').textContent = statusApplied.length;
      document.getElementById('interview-count').textContent = statusInterview.length;
      document.getElementById('offer-count').textContent = statusOffer.length;

      kanbanContainer.classList.remove('hidden');
      empty.classList.add('hidden');
      countEl.textContent = `${totalTracked} tracked`;
    }

    function createFeedCard(job) {
      const title = escapeHtml(job.title || 'Untitled');
      const company = escapeHtml(job.company || 'Unknown');
      const location = escapeHtml(job.location || 'Remote');
      const url = job.url || '#';
      const jobId = job.id;
      const salaryText = formatSalary(job.salary_min, job.salary_max);

      // Check if this job is saved (by URL for deduplication)
      const isSaved = savedJobsMap.has(url);
      const heartClass = isSaved ? 'fas fa-heart text-xl' : 'far fa-heart text-xl';
      const heartColor = isSaved ? 'text-red-500' : 'text-gray-300 hover:text-red-500';

      // Escape job data for safe inline JS
      const safeTitle = title.replace(/'/g, "\\'").replace(/"/g, '&quot;');
      const safeCompany = company.replace(/'/g, "\\'").replace(/"/g, '&quot;');
      const safeLocation = location.replace(/'/g, "\\'").replace(/"/g, '&quot;');
      const safeUrl = url.replace(/'/g, "\\'").replace(/"/g, '&quot;');

      return `
        <div class="card-hover bg-white rounded-xl border border-gray-200 overflow-hidden" data-job-id="${jobId}" data-job-url="${safeUrl}">
          <div class="p-4">
            <!-- Header -->
            <div class="flex items-start justify-between mb-3">
              <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold shrink-0">
                ${company.charAt(0).toUpperCase()}
              </div>
              <button onclick="toggleSave('${jobId}', '${safeUrl}', '${safeTitle}', '${safeCompany}', '${safeLocation}')" 
                      class="heart-btn p-2 ${heartColor} transition" 
                      title="${isSaved ? 'Unsave' : 'Save to My Applications'}" 
                      id="heart-${jobId}">
                <i class="${heartClass}"></i>
              </button>
            </div>
            
            <!-- Title & Company -->
            <h3 class="font-semibold text-gray-900 leading-tight mb-1 line-clamp-2">${title}</h3>
            <p class="text-blue-600 font-medium text-sm mb-2">${company}</p>
            
            <!-- Location & Salary Row -->
            <div class="flex items-center justify-between text-sm mb-4">
              <span class="text-gray-500 flex items-center">
                <i class="fas fa-map-marker-alt mr-1.5 text-gray-400 text-xs"></i>
                <span class="truncate max-w-[120px]">${location}</span>
              </span>
              ${salaryText ? `<span class="text-green-600 font-semibold">${salaryText}</span>` : '<span class="text-gray-400 text-xs">Salary not listed</span>'}
            </div>
            
            <!-- AI Action Buttons (2x3 Grid) -->
            <div class="grid grid-cols-2 gap-2 mb-3">
              <button id="btn-cv-${jobId}" onclick="tailorCV('${jobId}')" class="py-2 px-3 bg-blue-600 text-white text-xs font-medium rounded-lg hover:bg-blue-700 transition flex items-center justify-center">
                <i class="fas fa-file-alt mr-1.5"></i> Tailor CV
              </button>
              <button id="btn-email-${jobId}" onclick="draftEmail('${jobId}')" class="py-2 px-3 bg-green-600 text-white text-xs font-medium rounded-lg hover:bg-green-700 transition flex items-center justify-center">
                <i class="fas fa-envelope mr-1.5"></i> Draft Email
              </button>
              <button id="btn-cover-${jobId}" onclick="generateCoverLetter('${jobId}')" class="py-2 px-3 bg-indigo-600 text-white text-xs font-medium rounded-lg hover:bg-indigo-700 transition flex items-center justify-center">
                <i class="fas fa-file-signature mr-1.5"></i> Cover Letter
              </button>
              <button id="btn-interview-${jobId}" onclick="startInterview('${jobId}')" class="py-2 px-3 bg-purple-600 text-white text-xs font-medium rounded-lg hover:bg-purple-700 transition flex items-center justify-center">
                <i class="fas fa-microphone mr-1.5"></i> Interview Prep
              </button>
              <button id="btn-match-${jobId}" onclick="checkATSMatch('${jobId}')" class="col-span-2 py-2 px-3 bg-amber-500 text-white text-xs font-medium rounded-lg hover:bg-amber-600 transition flex items-center justify-center">
                <i class="fas fa-chart-pie mr-1.5"></i> Check ATS Match
              </button>
            </div>
          </div>
          
          <!-- Action Bar -->
          <div class="bg-gray-50 px-4 py-3 border-t border-gray-100">
            <a href="${url}" target="_blank" class="w-full py-2.5 bg-gray-800 text-white text-center font-medium rounded-lg hover:bg-gray-900 transition flex items-center justify-center">
              Apply Now <i class="fas fa-external-link-alt ml-2"></i>
            </a>
          </div>
        </div>
      `;
    }

    // --- Create Kanban Card HTML (With AI Buttons & Delete) ---
    function createKanbanCard(job, columnIndex) {
      const title = escapeHtml(job.title || 'Untitled');
      const company = escapeHtml(job.company || 'Unknown');
      const url = job.url || job.link || '#';  // Backend returns 'link' for saved_jobs
      const jobId = job.id;

      const canMoveLeft = columnIndex > 0;
      const canMoveRight = columnIndex < KANBAN_STATUSES.length - 1;

      return `
        <div class="kanban-card bg-white rounded-lg border border-gray-200 p-3 shadow-sm" data-job-id="${jobId}">
          <!-- Header with Title & Actions -->
          <div class="flex items-start justify-between mb-2">
            <div class="flex-1 min-w-0">
              <h4 class="font-semibold text-gray-900 text-sm leading-tight truncate">${title}</h4>
              <p class="text-blue-600 text-xs font-medium truncate">${company}</p>
            </div>
            <div class="flex items-center gap-1 ml-2">
              <a href="${url}" target="_blank" class="text-gray-400 hover:text-blue-500 p-1" title="View Job">
                <i class="fas fa-external-link-alt text-xs"></i>
              </a>
              <button onclick="deleteJob(${jobId})" class="text-gray-400 hover:text-red-500 p-1" title="Remove from saved">
                <i class="fas fa-trash-alt text-xs"></i>
              </button>
            </div>
          </div>
          
          <!-- AI Action Buttons (2x3 Grid) -->
          <div class="grid grid-cols-2 gap-1.5 mb-3">
            <button id="btn-cv-k${jobId}" onclick="tailorCV('${jobId}')" class="py-1.5 px-2 bg-blue-600 text-white text-xs font-medium rounded hover:bg-blue-700 transition flex items-center justify-center">
              <i class="fas fa-file-alt mr-1"></i> CV
            </button>
            <button id="btn-email-k${jobId}" onclick="draftEmail('${jobId}')" class="py-1.5 px-2 bg-green-600 text-white text-xs font-medium rounded hover:bg-green-700 transition flex items-center justify-center">
              <i class="fas fa-envelope mr-1"></i> Email
            </button>
            <button id="btn-cover-k${jobId}" onclick="generateCoverLetter('${jobId}')" class="py-1.5 px-2 bg-indigo-600 text-white text-xs font-medium rounded hover:bg-indigo-700 transition flex items-center justify-center">
              <i class="fas fa-file-signature mr-1"></i> Cover
            </button>
            <button id="btn-interview-k${jobId}" onclick="startInterview('${jobId}')" class="py-1.5 px-2 bg-purple-600 text-white text-xs font-medium rounded hover:bg-purple-700 transition flex items-center justify-center">
              <i class="fas fa-microphone mr-1"></i> Interview
            </button>
            <button id="btn-match-k${jobId}" onclick="checkATSMatch('${jobId}')" class="col-span-2 py-1.5 px-2 bg-amber-500 text-white text-xs font-medium rounded hover:bg-amber-600 transition flex items-center justify-center">
              <i class="fas fa-chart-pie mr-1"></i> ATS Match
            </button>
          </div>
          
          <!-- Move Buttons -->
          <div class="flex items-center justify-between pt-2 border-t border-gray-100">
            <button onclick="moveJob('${jobId}', -1)" ${!canMoveLeft ? 'disabled' : ''} class="move-btn px-3 py-1 text-xs text-gray-600 rounded hover:bg-gray-100 disabled:opacity-30" title="Move Left">
              <i class="fas fa-chevron-left mr-1"></i> Back
            </button>
            <button onclick="moveJob('${jobId}', 1)" ${!canMoveRight ? 'disabled' : ''} class="move-btn px-3 py-1 text-xs text-gray-600 rounded hover:bg-gray-100 disabled:opacity-30" title="Move Right">
              Next <i class="fas fa-chevron-right ml-1"></i>
            </button>
          </div>
        </div>
      `;
    }

    // --- Toggle Save (Heart Button) ---
    async function toggleSave(jobId, url, title, company, location) {
      const heartBtn = document.getElementById(`heart-${jobId}`);
      const heartIcon = heartBtn?.querySelector('i');

      // Check if already saved (by URL)
      const isCurrentlySaved = savedJobsMap.has(url);

      if (isCurrentlySaved) {
        // UNSAVE: Remove from saved jobs
        const savedJobId = savedJobsMap.get(url);

        // Visual update immediately
        if (heartIcon) {
          heartIcon.className = 'far fa-heart text-xl';
          heartBtn.classList.remove('text-red-500');
          heartBtn.classList.add('text-gray-300', 'hover:text-red-500');
          heartBtn.title = 'Save to My Applications';
        }

        // Remove from map
        savedJobsMap.delete(url);
        showToast('ðŸ—‘ï¸ Job removed from saved');

        // Persist to backend
        try {
          await fetch(`/api/saved-jobs/${savedJobId}`, { method: 'DELETE' });
        } catch (err) {
          console.log('Unsave failed:', err);
          // Revert on failure
          savedJobsMap.set(url, savedJobId);
        }

      } else {
        // SAVE: Add to saved jobs

        // Visual update immediately
        if (heartIcon) {
          heartIcon.className = 'fas fa-heart text-xl';
          heartBtn.classList.remove('text-gray-300', 'hover:text-red-500');
          heartBtn.classList.add('text-red-500');
          heartBtn.title = 'Unsave';
        }

        showToast('â¤ï¸ Job saved to My Applications!');

        // Persist to backend with full job data (URL is the dedup key)
        try {
          const res = await fetch('/api/save-job', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              url: url,
              title: title,
              company: company,
              location: location
            })
          });
          const data = await res.json();

          // Add to map (we'll fetch the real ID on next load)
          savedJobsMap.set(url, jobId);

        } catch (err) {
          console.log('Save failed:', err);
          // Revert visual on failure
          if (heartIcon) {
            heartIcon.className = 'far fa-heart text-xl';
            heartBtn.classList.remove('text-red-500');
            heartBtn.classList.add('text-gray-300', 'hover:text-red-500');
          }
          savedJobsMap.delete(url);
        }
      }
    }

    // --- Move Job (Arrow Buttons in Kanban) ---
    async function moveJob(jobId, direction) {
      // Look in savedJobs (Kanban uses savedJobs from API)
      const job = savedJobs.find(j => j.id == jobId);
      if (!job) {
        console.log('Job not found in savedJobs:', jobId);
        return;
      }

      // Normalize status
      let currentStatus = (job.status || 'Saved').toLowerCase();
      if (currentStatus === 'interviewing') currentStatus = 'interview';

      const currentIndex = KANBAN_STATUSES.indexOf(currentStatus);
      const newIndex = currentIndex + direction;

      if (newIndex < 0 || newIndex >= KANBAN_STATUSES.length) return;

      const newStatus = KANBAN_STATUSES[newIndex];
      const capitalizedStatus = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);

      // Update local state immediately
      job.status = capitalizedStatus;  // Backend uses capitalized status

      // Re-render kanban
      renderKanban();

      const statusEmojis = { 'saved': 'ðŸ“Œ', 'applied': 'ðŸ“¤', 'interview': 'ðŸŽ¤', 'offer': 'ðŸŽ‰' };
      showToast(`${statusEmojis[newStatus] || 'âœ“'} Moved to ${capitalizedStatus}`);

      // Persist to backend
      try {
        await fetch('/api/update-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: jobId, status: capitalizedStatus })
        });
      } catch (err) {
        console.log('Status persist skipped:', err);
      }
    }

    // --- Delete Job (Remove from Kanban) ---
    async function deleteJob(jobId) {
      // Find the job in savedJobs to get its URL
      const job = savedJobs.find(j => j.id == jobId);

      // Remove from local state immediately
      savedJobs = savedJobs.filter(j => j.id != jobId);

      // Also remove from savedJobsMap
      if (job) {
        const url = job.url || job.link || '';
        if (url) savedJobsMap.delete(url);
      }

      // Re-render kanban
      renderKanban();
      showToast('ðŸ—‘ï¸ Job removed from saved');

      // Persist to backend
      try {
        await fetch(`/api/saved-jobs/${jobId}`, { method: 'DELETE' });
      } catch (err) {
        console.log('Delete failed:', err);
      }
    }

    // --- Trigger Scrape ---
    async function triggerScrape() {
      const queryInput = document.getElementById('search-query');
      const locationInput = document.getElementById('search-location');
      const btn = document.getElementById('search-btn');

      const query = queryInput.value.trim();
      const location = locationInput.value.trim();

      if (!query) {
        queryInput.focus();
        queryInput.classList.add('ring-2', 'ring-red-500');
        setTimeout(() => queryInput.classList.remove('ring-2', 'ring-red-500'), 2000);
        return;
      }

      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Searching...';
      btn.disabled = true;

      // STEP 1: WIPE - Clear existing jobs BEFORE search
      allJobs = [];
      document.getElementById('jobs-container').innerHTML = '';
      document.getElementById('job-count').textContent = 'Searching...';
      document.getElementById('loading').classList.remove('hidden');

      try {
        let url = `/jobs/scrape-sync?query=${encodeURIComponent(query)}`;
        if (location) url += `&location=${encodeURIComponent(location)}`;

        const res = await fetch(url, { method: 'POST' });
        const data = await res.json();

        const added = data.added || 0;
        const loc = data.location || location || 'any location';

        // STEP 2: USE RETURNED JOBS DIRECTLY (no stale data from /jobs)
        const freshJobs = data.jobs || [];
        allJobs = freshJobs;

        console.log(`âœ… Search returned ${freshJobs.length} filtered jobs`);
        showToast(`âœ… Found ${freshJobs.length} jobs for "${query}" in ${loc}!`);

        // STEP 3: RENDER - Switch to feed tab and render fresh jobs
        document.getElementById('loading').classList.add('hidden');
        currentTab = 'feed';
        switchTab('feed');
        renderJobs();

      } catch (err) {
        document.getElementById('loading').classList.add('hidden');
        showToast(`âŒ Search failed: ${err.message}`, 'error');
      } finally {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
      }
    }

    // --- Toast Notification ---
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `fixed bottom-6 right-6 px-5 py-3 rounded-xl shadow-lg text-white font-medium z-50 transition-all text-sm ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // --- PDF Upload Handler ---
    async function handlePdfUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.name.toLowerCase().endsWith('.pdf')) {
        showToast('Please upload a PDF file.', 'error');
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        showToast('File too large. Max 5MB.', 'error');
        return;
      }

      document.getElementById('drop-zone-content').classList.add('hidden');
      document.getElementById('drop-zone-success').classList.add('hidden');
      document.getElementById('drop-zone-loading').classList.remove('hidden');

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch('/api/upload-resume', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (data.text) {
          document.getElementById('profile-resume').value = data.text;
          if (data.skills) {
            document.getElementById('profile-skills').value = data.skills;
          }

          document.getElementById('drop-zone-loading').classList.add('hidden');
          document.getElementById('drop-zone-success').classList.remove('hidden');
          document.getElementById('pdf-filename').textContent = file.name;
        } else {
          throw new Error(data.error || 'Failed to parse PDF');
        }
      } catch (err) {
        showToast('Failed to parse PDF: ' + err.message, 'error');
        document.getElementById('drop-zone-loading').classList.add('hidden');
        document.getElementById('drop-zone-content').classList.remove('hidden');
      }
    }

    // --- Drag and Drop for PDF ---
    document.addEventListener('DOMContentLoaded', () => {
      const dropZone = document.getElementById('drop-zone');

      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          dropZone.classList.add('dragover');
        });
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          dropZone.classList.remove('dragover');
        });
      });

      dropZone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          document.getElementById('pdf-input').files = files;
          handlePdfUpload({ target: { files: files } });
        }
      });
    });

    // --- AI Feature Functions ---

    // Helper: Ensure job is saved before AI action (fixes "Click = Nothing" bug on Feed jobs)
    async function ensureJobSaved(jobId) {
      // Find the job in allJobs (feed) to get its data
      const job = allJobs.find(j => j.id == jobId);
      if (!job) {
        // Job might already be in savedJobs (Kanban view)
        const savedJob = savedJobs.find(j => j.id == jobId);
        if (savedJob) return jobId;  // Already saved, return existing ID
        console.log('Job not found:', jobId);
        return null;
      }

      const url = job.url || '';

      // If already saved, return the saved ID
      if (savedJobsMap.has(url)) {
        return savedJobsMap.get(url);
      }

      // GHOST SAVE: Do NOT change heart icon - job is saved for AI only
      // User doesn't see it in Kanban unless they explicitly click the heart

      // Ghost-save the job (for AI features only)
      try {
        const res = await fetch('/api/save-job', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url: url,
            title: job.title || 'Untitled',
            company: job.company || 'Unknown',
            location: job.location || 'Remote',
            ghost: true  // Ghost save - not visible in Kanban
          })
        });
        const data = await res.json();
        const newJobId = data.id || jobId;

        // Update savedJobsMap for internal tracking
        savedJobsMap.set(url, newJobId);

        // No toast, no heart change - silent save for AI features
        return newJobId;

      } catch (err) {
        console.log('Ghost save failed:', err);
        return jobId;  // Try with original ID anyway
      }
    }

    async function draftEmail(jobId) {
      // Auto-save if from Feed
      const savedId = await ensureJobSaved(jobId);
      if (!savedId) {
        showToast('âŒ Could not find job', 'error');
        return;
      }

      const btn = document.getElementById(`btn-email-${jobId}`) || document.getElementById(`btn-email-k${jobId}`);
      const originalHTML = btn?.innerHTML;
      if (btn) {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.classList.add('btn-loading');
      }

      try {
        const res = await fetch('/api/generate-cold-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ job_id: savedId })  // Use savedId
        });
        const data = await res.json();

        if (data.error && data.error !== "Parsing failed") {
          showResult('Error', `<p class="text-red-600">${escapeHtml(data.error)}</p>`);
        } else {
          const subject = escapeHtml(data.subject || 'No subject');
          const body = escapeHtml(data.body || 'No content').replace(/\n/g, '<br>');
          currentResultText = `Subject: ${data.subject}\n\n${data.body}`;
          showResult('ðŸ“§ Cold Email', `
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-500 mb-1">Subject</label>
                            <p class="text-lg font-semibold text-gray-900">${subject}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-500 mb-1">Body</label>
                            <div class="bg-gray-50 rounded-lg p-4 text-gray-800 leading-relaxed">${body}</div>
                        </div>
                    `);
        }
      } catch (err) {
        showResult('Error', `<p class="text-red-600">${err.message}</p>`);
      } finally {
        if (btn && originalHTML) {
          btn.innerHTML = originalHTML;
          btn.classList.remove('btn-loading');
        }
      }
    }

    async function generateCoverLetter(jobId) {
      // Auto-save if from Feed
      const savedId = await ensureJobSaved(jobId);
      if (!savedId) {
        showToast('âŒ Could not find job', 'error');
        return;
      }

      const btn = document.getElementById(`btn-cover-${jobId}`) || document.getElementById(`btn-cover-k${jobId}`);
      const originalHTML = btn?.innerHTML;
      if (btn) {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.classList.add('btn-loading');
      }

      try {
        const res = await fetch('/api/generate-cover-letter', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ job_id: savedId })  // Use savedId
        });
        const data = await res.json();

        if (data.error && !data.full_letter) {
          showResult('Error', `<p class="text-red-600">${escapeHtml(data.error)}</p>`);
        } else {
          const letter = data.full_letter || `${data.greeting || ''}\n\n${data.body || ''}\n\n${data.closing || ''}`;
          currentResultText = letter;
          showResult('ðŸ“ Cover Letter', `
                        <div class="bg-gray-50 rounded-lg p-6 text-gray-800 leading-relaxed whitespace-pre-wrap">${escapeHtml(letter)}</div>
                    `);
        }
      } catch (err) {
        showResult('Error', `<p class="text-red-600">${err.message}</p>`);
      } finally {
        if (btn && originalHTML) {
          btn.innerHTML = originalHTML;
          btn.classList.remove('btn-loading');
        }
      }
    }

    async function tailorCV(jobId) {
      // Auto-save if from Feed
      const savedId = await ensureJobSaved(jobId);
      if (!savedId) {
        showToast('âŒ Could not find job', 'error');
        return;
      }

      // Store current job for verify score feature
      const job = allJobs.find(j => j.id == jobId) || savedJobs.find(j => j.id == jobId);
      window.currentCVJob = job;  // Store globally for verify score

      const btn = document.getElementById(`btn-cv-${jobId}`) || document.getElementById(`btn-cv-k${jobId}`);
      const originalHTML = btn?.innerHTML;
      if (btn) {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.classList.add('btn-loading');
      }

      try {
        const res = await fetch('/api/generate-curated-cv', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ job_id: savedId, gap_answers: [] })  // Use savedId
        });
        const data = await res.json();

        if (data.error) {
          showResult('Error', `<p class="text-red-600">${escapeHtml(data.error)}</p>`);
          // Hide footer verify button for errors
          document.getElementById('footer-verify-container')?.classList.add('hidden');
        } else {
          currentResultText = data.cv_html || '';

          // Include Smart Fix metadata if available (Preservation Protocol)
          const preserved = data.smart_fix?.keywords_preserved || 0;
          const injected = data.smart_fix?.missing_keywords?.length || 0;
          const smartFixInfo = data.smart_fix ? `
            <div class="mb-3 p-3 bg-gradient-to-r from-blue-50 to-green-50 border border-blue-200 rounded-lg text-sm flex items-center gap-4">
              <span class="font-semibold text-blue-800">ðŸŽ¯ Smart Fix:</span>
              <span class="text-green-700">âœ“ ${preserved} keywords preserved</span>
              <span class="text-blue-700">+ ${injected} keywords added</span>
            </div>
          ` : '';

          showResult('ðŸ“„ Tailored CV', `
            <!-- Score Display Container (hidden by default) -->
            <div id="new-score-container" class="hidden mb-4 p-4 rounded-lg flex justify-between items-center">
              <span class="font-bold" id="new-ats-score-display"></span>
            </div>
            
            ${smartFixInfo}
            
            <div class="bg-white border rounded-lg p-6 cv-preview overflow-auto" id="cv-preview-content">
              ${data.cv_html || '<p class="text-gray-500">No CV generated</p>'}
            </div>
          `);

          // Show and wire the FOOTER verify button (sticky)
          const footerVerifyContainer = document.getElementById('footer-verify-container');
          const footerSpacer = document.getElementById('footer-spacer');
          if (footerVerifyContainer) {
            footerVerifyContainer.classList.remove('hidden');
            if (footerSpacer) footerSpacer.classList.add('hidden');
          }

          // Wire up the footer verify button
          setTimeout(() => wireVerifyScoreButtonFooter(), 100);
        }
      } catch (err) {
        showResult('Error', `<p class="text-red-600">${err.message}</p>`);
      } finally {
        if (btn && originalHTML) {
          btn.innerHTML = originalHTML;
          btn.classList.remove('btn-loading');
        }
      }
    }

    // --- ATS Match Checker ---
    async function checkATSMatch(jobId) {
      // Get job data FIRST (before save might not be committed)
      const job = allJobs.find(j => j.id == jobId) || savedJobs.find(j => j.id == jobId);
      const jobTitle = job?.title || 'Job';
      const jobCompany = job?.company || 'Company';
      const jobDescription = job?.description || '';

      const btn = document.getElementById(`btn-match-${jobId}`) || document.getElementById(`btn-match-k${jobId}`);
      const originalHTML = btn?.innerHTML;
      if (btn) {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        btn.classList.add('btn-loading');
      }

      try {
        // STEP 1: Fetch profile to get resume
        const profileRes = await fetch('/api/get-profile');
        const profileData = await profileRes.json();
        const resumeText = profileData.resume_text || '';

        if (!resumeText || resumeText.length < 50) {
          if (btn && originalHTML) {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-loading');
          }
          showToast('ðŸ“„ Please upload your resume in the Profile section first!', 'error');
          return;
        }

        // STEP 2: Auto-save if from Feed (Ghost Save)
        const savedId = await ensureJobSaved(jobId);
        if (!savedId) {
          if (btn && originalHTML) {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-loading');
          }
          showToast('âŒ Could not find job', 'error');
          return;
        }

        // STEP 3: Small delay to ensure DB commit (race condition mitigation)
        await new Promise(resolve => setTimeout(resolve, 300));

        // STEP 4: Call analyze with BOTH job data AND resume
        const res = await fetch('/api/job/analyze-match', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            job_id: savedId,
            resume_text: resumeText,    // â† Pass resume explicitly!
            job_title: jobTitle,
            company: jobCompany,
            job_description: jobDescription
          })
        });
        const data = await res.json();

        if (data.error) {
          showResult('ATS Match', `<p class="text-red-600">${escapeHtml(data.error)}</p>`);
          return;
        }

        // Parse analysis
        const analysis = data.analysis || {};
        const matchScore = analysis.match_score || 50;
        const matchingStrengths = analysis.matching_strengths || ['Good foundation'];
        const missingSkills = analysis.missing_skills || ['Review requirements'];
        const experienceMatch = analysis.experience_match || 'Moderate';
        const recommendation = analysis.recommendation || 'Partial fit';

        // Determine colors
        const scoreColor = matchScore >= 70 ? '#10b981' : matchScore >= 50 ? '#f59e0b' : '#ef4444';
        const expColor = experienceMatch === 'Strong' ? 'bg-green-100 text-green-800' :
          experienceMatch === 'Weak' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
        const recColor = recommendation.includes('Strong') ? 'bg-green-100 text-green-800' :
          recommendation.includes('Needs') ? 'bg-red-100 text-red-800' : 'bg-amber-100 text-amber-800';

        // Build visual report card
        const reportHTML = `
          <div class="space-y-6">
            <!-- Header -->
            <div class="text-center">
              <p class="text-sm text-gray-500 mb-1">${escapeHtml(jobTitle)}</p>
              <p class="text-xs text-gray-400">${escapeHtml(jobCompany)}</p>
            </div>

            <!-- Match Score Circle -->
            <div class="flex justify-center py-4">
              <div class="relative">
                <div class="w-36 h-36 rounded-full flex items-center justify-center"
                     style="background: conic-gradient(${scoreColor} ${matchScore}%, #e5e7eb ${matchScore}% 100%);">
                  <div class="w-28 h-28 bg-white rounded-full flex items-center justify-center shadow-inner">
                    <div class="text-center">
                      <span class="text-4xl font-bold" style="color: ${scoreColor}">${matchScore}</span>
                      <span class="text-gray-400 text-lg">%</span>
                      <p class="text-xs text-gray-500 mt-1">ATS Match</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Badges Row -->
            <div class="flex justify-center gap-3">
              <span class="px-3 py-1 rounded-full text-xs font-medium ${expColor}">${experienceMatch} Experience</span>
              <span class="px-3 py-1 rounded-full text-xs font-medium ${recColor}">${recommendation}</span>
            </div>

            <!-- Skills Grid -->
            <div class="grid grid-cols-2 gap-4 pt-4 border-t border-gray-100">
              <!-- Matching Strengths -->
              <div>
                <h4 class="text-sm font-semibold text-green-700 mb-3 flex items-center gap-2">
                  <span class="w-5 h-5 bg-green-100 rounded-full flex items-center justify-center text-xs">âœ“</span>
                  You Have
                </h4>
                <ul class="space-y-2">
                  ${matchingStrengths.map(s => `
                    <li class="flex items-start gap-2 text-sm text-gray-700">
                      <span class="text-green-500 mt-0.5">âœ“</span>
                      <span>${escapeHtml(s)}</span>
                    </li>
                  `).join('')}
                </ul>
              </div>

              <!-- Missing Skills -->
              <div>
                <h4 class="text-sm font-semibold text-red-700 mb-3 flex items-center gap-2">
                  <span class="w-5 h-5 bg-red-100 rounded-full flex items-center justify-center text-xs">!</span>
                  Missing
                </h4>
                <ul class="space-y-2">
                  ${missingSkills.map(s => `
                    <li class="flex items-start gap-2 text-sm text-gray-700">
                      <span class="text-red-500 mt-0.5">âœ—</span>
                      <span>${escapeHtml(s)}</span>
                    </li>
                  `).join('')}
                </ul>
              </div>
            </div>

            <!-- Tip -->
            <div class="bg-blue-50 rounded-lg p-3 text-center">
              <p class="text-xs text-blue-700">
                <i class="fas fa-lightbulb mr-1"></i>
                Tip: Add missing skills to your resume or cover letter to improve your match score.
              </p>
            </div>
          </div>
        `;

        showResult('ðŸ“Š ATS Match Report', reportHTML);

      } catch (err) {
        showResult('Error', `<p class="text-red-600">${err.message}</p>`);
      } finally {
        if (btn && originalHTML) {
          btn.innerHTML = originalHTML;
          btn.classList.remove('btn-loading');
        }
      }
    }

    // --- Deterministic Interview State Machine ---
    let currentInterviewJobId = null;
    let interviewQuestions = [];      // Pre-generated 5 questions
    let userAnswers = [];             // User's answers
    let currentQuestionIndex = 0;     // Current question (0-4)
    const MAX_QUESTIONS = 5;
    let speechRecognition = null;
    let currentTranscript = '';
    // Legacy support
    let interviewHistory = [];
    let interviewQuestionCount = 0;

    async function startInterview(jobId) {
      // Get job data first (before save might not be committed)
      const job = allJobs.find(j => j.id == jobId) || savedJobs.find(j => j.id == jobId);
      const jobTitle = job?.title || 'the role';
      const jobCompany = job?.company || 'the company';

      // Auto-save if from Feed
      const savedId = await ensureJobSaved(jobId);
      if (!savedId) {
        showToast('âŒ Could not find job', 'error');
        return;
      }

      const btn = document.getElementById(`btn-interview-${jobId}`) || document.getElementById(`btn-interview-k${jobId}`);
      const originalHTML = btn?.innerHTML;
      if (btn) {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
        btn.classList.add('btn-loading');
      }

      try {
        // Small delay to ensure DB commit (race condition mitigation)
        await new Promise(resolve => setTimeout(resolve, 300));

        // STEP 1: Generate all 5 questions upfront (DETERMINISTIC)
        // Pass job data as fallback in case DB lookup fails
        const res = await fetch('/api/interview/generate-questions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            job_id: savedId,
            resume_text: '',
            job_title: jobTitle,   // Fallback for race condition
            company: jobCompany    // Fallback for race condition
          })
        });
        const data = await res.json();

        if (data.error) {
          showToast('âŒ ' + data.error, 'error');
          return;
        }

        // STEP 2: Initialize state machine
        currentInterviewJobId = savedId;
        interviewQuestions = data.questions || [];
        userAnswers = [];
        currentQuestionIndex = 0;
        interviewHistory = [];
        interviewQuestionCount = 1;

        if (interviewQuestions.length === 0) {
          showToast('âŒ Could not generate questions', 'error');
          return;
        }

        console.log('âœ… Generated interview questions:', interviewQuestions);

        // STEP 3: Open modal with first question
        openInterviewModal(jobTitle, interviewQuestions[0]);

      } catch (err) {
        showToast('âŒ ' + err.message, 'error');
      } finally {
        if (btn && originalHTML) {
          btn.innerHTML = originalHTML;
          btn.classList.remove('btn-loading');
        }
      }
    }

    function openInterviewModal(jobTitle, firstQuestion) {
      // Reset UI
      document.getElementById('interview-job-title').textContent = jobTitle;
      document.getElementById('interview-counter').textContent = `Question ${interviewQuestionCount} of ${MAX_QUESTIONS}`;
      document.getElementById('interview-question').textContent = firstQuestion;
      document.getElementById('interview-status').textContent = 'AI is speaking...';
      document.getElementById('interview-complete').classList.add('hidden');

      // Hide all buttons initially
      document.getElementById('btn-start-recording').classList.add('hidden');
      document.getElementById('btn-stop-recording').classList.add('hidden');
      document.getElementById('interview-processing').classList.add('hidden');
      document.getElementById('sound-wave').classList.add('hidden');

      // Show modal
      document.getElementById('interview-modal').classList.remove('hidden');

      // Start speaking the question
      speakQuestion(firstQuestion);
    }

    function closeInterviewModal() {
      document.getElementById('interview-modal').classList.add('hidden');
      currentInterviewJobId = null;
      interviewQuestions = [];
      userAnswers = [];
      currentQuestionIndex = 0;
      interviewHistory = [];
      interviewQuestionCount = 0;

      // Stop any ongoing speech
      if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
      }
      if (speechRecognition) {
        speechRecognition.abort();
        speechRecognition = null;
      }

      // Remove orb animation
      document.getElementById('ai-orb').classList.remove('orb-speaking');
    }

    function speakQuestion(text) {
      const orb = document.getElementById('ai-orb');
      const statusEl = document.getElementById('interview-status');
      const startBtn = document.getElementById('btn-start-recording');

      // Add speaking animation
      orb.classList.add('orb-speaking');
      statusEl.textContent = 'AI is speaking...';

      // Check if speech synthesis is available
      if (!window.speechSynthesis) {
        // Fallback: just show the button after a delay
        setTimeout(() => {
          orb.classList.remove('orb-speaking');
          statusEl.textContent = 'Your turn to answer';
          startBtn.classList.remove('hidden');
        }, 2000);
        return;
      }

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 0.95;
      utterance.pitch = 1;

      utterance.onend = () => {
        orb.classList.remove('orb-speaking');
        statusEl.textContent = 'Your turn to answer';
        startBtn.classList.remove('hidden');
      };

      utterance.onerror = () => {
        orb.classList.remove('orb-speaking');
        statusEl.textContent = 'Your turn to answer';
        startBtn.classList.remove('hidden');
      };

      window.speechSynthesis.speak(utterance);
    }

    function startRecording() {
      const startBtn = document.getElementById('btn-start-recording');
      const stopBtn = document.getElementById('btn-stop-recording');
      const soundWave = document.getElementById('sound-wave');
      const statusEl = document.getElementById('interview-status');

      // Check for speech recognition support
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      if (!SpeechRecognition) {
        // Fallback to text input modal
        const answer = prompt('Speech recognition not available. Type your answer:');
        if (answer && answer.trim()) {
          currentTranscript = answer.trim();
          submitAnswer();
        }
        return;
      }

      // Initialize speech recognition
      speechRecognition = new SpeechRecognition();
      speechRecognition.continuous = true;
      speechRecognition.interimResults = false;
      speechRecognition.lang = 'en-US';

      currentTranscript = '';

      speechRecognition.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            currentTranscript += event.results[i][0].transcript + ' ';
          }
        }
      };

      speechRecognition.onerror = (event) => {
        console.log('Speech recognition error:', event.error);
        if (event.error === 'no-speech') {
          statusEl.textContent = 'No speech detected. Try again.';
        }
      };

      speechRecognition.onend = () => {
        // Recognition ended naturally
      };

      // Start listening
      try {
        speechRecognition.start();

        // Update UI
        startBtn.classList.add('hidden');
        stopBtn.classList.remove('hidden');
        soundWave.classList.remove('hidden');
        statusEl.textContent = 'Listening... (transcription hidden)';

      } catch (err) {
        console.log('Speech recognition start error:', err);
        statusEl.textContent = 'Could not start recording';
      }
    }

    function stopRecording() {
      const stopBtn = document.getElementById('btn-stop-recording');
      const soundWave = document.getElementById('sound-wave');
      const processingEl = document.getElementById('interview-processing');
      const statusEl = document.getElementById('interview-status');

      // Stop recognition
      if (speechRecognition) {
        speechRecognition.stop();
      }

      // Update UI
      stopBtn.classList.add('hidden');
      soundWave.classList.add('hidden');
      processingEl.classList.remove('hidden');
      statusEl.textContent = '';

      // Short delay to ensure transcript is complete
      setTimeout(() => {
        submitAnswer();
      }, 500);
    }

    function submitAnswer() {
      // DETERMINISTIC STATE MACHINE - No AI calls between questions
      const processingEl = document.getElementById('interview-processing');
      const questionEl = document.getElementById('interview-question');
      const counterEl = document.getElementById('interview-counter');
      const statusEl = document.getElementById('interview-status');

      const answer = currentTranscript.trim();

      if (!answer) {
        processingEl.classList.add('hidden');
        statusEl.textContent = 'No answer detected. Tap to try again.';
        document.getElementById('btn-start-recording').classList.remove('hidden');
        return;
      }

      // STEP 1: Save answer to array
      userAnswers.push({
        question: interviewQuestions[currentQuestionIndex],
        answer: answer
      });

      // Legacy history support
      interviewHistory.push({ role: 'user', message: answer });

      processingEl.classList.add('hidden');

      // STEP 2: Move to next question
      currentQuestionIndex++;
      interviewQuestionCount++;

      // STEP 3: Check if interview complete
      if (currentQuestionIndex >= interviewQuestions.length) {
        console.log('âœ… Interview complete. Answers:', userAnswers);
        showInterviewComplete();
        return;
      }

      // STEP 4: Show next pre-generated question (NO AI CALL!)
      const nextQuestion = interviewQuestions[currentQuestionIndex];
      interviewHistory.push({ role: 'interviewer', message: nextQuestion });

      // Update UI
      counterEl.textContent = `Question ${currentQuestionIndex + 1} of ${MAX_QUESTIONS}`;
      questionEl.className = 'text-xl text-gray-800 leading-relaxed font-medium fade-in';
      questionEl.textContent = nextQuestion;

      // Speak next question
      speakQuestion(nextQuestion);
    }

    function showInterviewComplete() {
      document.getElementById('interview-complete').classList.remove('hidden');
    }

    async function generateInterviewAnalysis() {
      showToast('ðŸ“Š Generating interview analysis...');

      try {
        // Send the properly formatted conversation (question/answer pairs)
        const res = await fetch('/api/interview/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            job_id: currentInterviewJobId,
            conversation: userAnswers  // Array of {question, answer} objects
          })
        });
        const data = await res.json();

        // Keep modal open until we have data ready
        if (data.error) {
          closeInterviewModal();
          showResult('Interview Analysis', `<p class="text-red-600">${escapeHtml(data.error)}</p>`);
          return;
        }

        // Parse structured analysis
        const analysis = data.analysis || {};
        const overallScore = analysis.overall_score || 6;
        const technicalMatch = analysis.technical_match || 60;
        const communicationScore = analysis.communication_score || 65;
        const starMethod = analysis.star_method_usage || 'Partial';
        const strengths = analysis.strengths || ['Good effort'];
        const improvements = analysis.improvements || ['Keep practicing'];
        const sentiment = analysis.summary_sentiment || 'Neutral';

        // Close modal NOW that data is ready
        closeInterviewModal();

        // Determine colors based on score
        const scoreColor = overallScore >= 7 ? '#10b981' : overallScore >= 5 ? '#f59e0b' : '#ef4444';
        const sentimentColor = sentiment === 'Positive' ? 'bg-green-100 text-green-800' :
          sentiment === 'Caution' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
        const sentimentIcon = sentiment === 'Positive' ? 'âœ“' : sentiment === 'Caution' ? '!' : 'â—‹';

        // Build visual report card HTML
        const reportHTML = `
          <div class="space-y-6">
            <!-- Header with Sentiment Badge -->
            <div class="flex items-center justify-between">
              <span class="text-sm uppercase tracking-wider text-gray-500 font-medium">Performance Analysis</span>
              <span class="px-3 py-1 rounded-full text-xs font-semibold ${sentimentColor}">${sentimentIcon} ${sentiment}</span>
            </div>

            <!-- Overall Score Circle -->
            <div class="flex justify-center py-4">
              <div class="relative">
                <div class="w-32 h-32 rounded-full flex items-center justify-center"
                     style="background: conic-gradient(${scoreColor} ${overallScore * 10}%, #e5e7eb ${overallScore * 10}% 100%);">
                  <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center shadow-inner">
                    <div class="text-center">
                      <span class="text-3xl font-bold" style="color: ${scoreColor}">${overallScore}</span>
                      <span class="text-gray-400 text-lg">/10</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Progress Bars -->
            <div class="grid grid-cols-2 gap-4">
              <!-- Technical Match -->
              <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-medium text-gray-700">Technical Match</span>
                  <span class="text-sm font-bold text-blue-600">${technicalMatch}%</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-blue-400 to-blue-600 rounded-full transition-all duration-500"
                       style="width: ${technicalMatch}%"></div>
                </div>
              </div>

              <!-- Communication -->
              <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-medium text-gray-700">Communication</span>
                  <span class="text-sm font-bold text-purple-600">${communicationScore}%</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-purple-400 to-purple-600 rounded-full transition-all duration-500"
                       style="width: ${communicationScore}%"></div>
                </div>
              </div>
            </div>

            <!-- STAR Method Badge -->
            <div class="flex items-center justify-center gap-2 text-sm">
              <span class="text-gray-500">STAR Method:</span>
              <span class="px-2 py-0.5 rounded ${starMethod === 'Yes' ? 'bg-green-100 text-green-700' : starMethod === 'Partial' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'} font-medium">${starMethod}</span>
            </div>

            <!-- Strengths & Improvements -->
            <div class="grid grid-cols-2 gap-4 pt-4 border-t border-gray-100">
              <!-- Strengths -->
              <div>
                <h4 class="text-sm font-semibold text-green-700 mb-3 flex items-center gap-2">
                  <span class="w-5 h-5 bg-green-100 rounded-full flex items-center justify-center text-xs">âœ“</span>
                  Strengths
                </h4>
                <ul class="space-y-2">
                  ${strengths.map(s => `
                    <li class="flex items-start gap-2 text-sm text-gray-700">
                      <span class="text-green-500 mt-0.5">âœ“</span>
                      <span>${escapeHtml(s)}</span>
                    </li>
                  `).join('')}
                </ul>
              </div>

              <!-- Improvements -->
              <div>
                <h4 class="text-sm font-semibold text-amber-700 mb-3 flex items-center gap-2">
                  <span class="w-5 h-5 bg-amber-100 rounded-full flex items-center justify-center text-xs">â†‘</span>
                  To Improve
                </h4>
                <ul class="space-y-2">
                  ${improvements.map(i => `
                    <li class="flex items-start gap-2 text-sm text-gray-700">
                      <span class="text-amber-500 mt-0.5">â†’</span>
                      <span>${escapeHtml(i)}</span>
                    </li>
                  `).join('')}
                </ul>
              </div>
            </div>

            <!-- Footer -->
            <div class="text-center text-xs text-gray-400 pt-4 border-t border-gray-100">
              Based on ${data.questions_answered || userAnswers.length} questions answered
            </div>
          </div>
        `;

        showResult('ðŸ“Š Interview Report Card', reportHTML);

      } catch (err) {
        closeInterviewModal();
        showResult('Error', `<p class="text-red-600">${err.message}</p>`);
      }
    }

    // --- Profile Modal ---
    async function openProfileModal() {
      document.getElementById('profile-modal').classList.remove('hidden');

      document.getElementById('drop-zone-content').classList.remove('hidden');
      document.getElementById('drop-zone-loading').classList.add('hidden');
      document.getElementById('drop-zone-success').classList.add('hidden');

      try {
        const res = await fetch('/api/get-profile');
        const data = await res.json();
        document.getElementById('profile-resume').value = data.resume_text || '';
        document.getElementById('profile-skills').value = data.skills || '';

        if (data.resume_text && data.resume_text.length > 100) {
          document.getElementById('drop-zone-content').classList.add('hidden');
          document.getElementById('drop-zone-success').classList.remove('hidden');
          document.getElementById('pdf-filename').textContent = 'Resume loaded';
        }
      } catch (err) { }
    }

    function closeProfileModal() {
      document.getElementById('profile-modal').classList.add('hidden');
    }

    async function saveProfile() {
      const resume = document.getElementById('profile-resume').value;
      const skills = document.getElementById('profile-skills').value;

      try {
        await fetch('/api/save-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ resume_text: resume, skills: skills })
        });
        closeProfileModal();
        updateProfileStatus(resume);
        showToast('âœ… Profile saved!');
      } catch (err) {
        showToast('âŒ Failed to save', 'error');
      }
    }

    function updateProfileStatus(resumeText) {
      const el = document.getElementById('profile-status');
      if (resumeText && resumeText.length > 50) {
        el.innerHTML = `<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs"><i class="fas fa-check-circle mr-1"></i> Resume Loaded</span>`;
      } else {
        el.innerHTML = `<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs"><i class="fas fa-exclamation-circle mr-1"></i> No Resume</span>`;
      }
    }

    // --- Result Modal ---
    function showResult(title, content) {
      document.getElementById('result-title').textContent = title;
      document.getElementById('result-content').innerHTML = content;
      document.getElementById('result-modal').classList.remove('hidden');
    }

    function closeResultModal() {
      document.getElementById('result-modal').classList.add('hidden');
      resetResultModalFooter();  // Reset footer button state
    }

    function copyResultToClipboard() {
      if (currentResultText) {
        navigator.clipboard.writeText(currentResultText);
        showToast('âœ… Copied!');
      }
    }

    // --- Verify New CV Score ---
    function wireVerifyScoreButton() {
      const btn = document.getElementById('btn-verify-score');
      if (!btn) return;

      btn.addEventListener('click', async function () {
        const job = window.currentCVJob;
        if (!job) {
          showToast('âŒ No job context found', 'error');
          return;
        }

        // Get the CV text from the preview
        const cvContent = document.getElementById('cv-preview-content');
        const cvText = cvContent ? cvContent.innerText : currentResultText;

        if (!cvText || cvText.length < 50) {
          showToast('âŒ No CV content to analyze', 'error');
          return;
        }

        const jobDescription = job.description || '';
        if (!jobDescription || jobDescription.length < 50) {
          showToast('âš ï¸ Job description too short for analysis', 'error');
          return;
        }

        // Show loading state
        const btnText = document.getElementById('btn-verify-text');
        const originalText = btnText?.innerText || 'Check New ATS Score';
        if (btnText) btnText.innerText = 'Analyzing...';
        btn.disabled = true;

        try {
          const response = await fetch('/api/job/analyze-match', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              resume_text: cvText,
              job_description: jobDescription,
              job_title: job.title || 'Position',
              company: job.company || 'Company'
            })
          });

          const data = await response.json();

          // Show the result
          const scoreContainer = document.getElementById('new-score-container');
          const scoreDisplay = document.getElementById('new-ats-score-display');

          if (scoreContainer && scoreDisplay) {
            const analysis = data.analysis || {};
            const matchScore = analysis.match_score || data.match_score || 50;

            scoreContainer.classList.remove('hidden');
            scoreDisplay.innerHTML = `ðŸš€ <span class="text-2xl">${matchScore}%</span> ATS Match Score`;

            // Visual feedback based on score
            if (matchScore >= 80) {
              scoreContainer.className = "mb-4 p-4 bg-green-100 border-2 border-green-400 rounded-lg flex justify-between items-center text-green-900";
              scoreDisplay.innerHTML += ' <span class="text-sm font-normal ml-2">âœ¨ Excellent match!</span>';
            } else if (matchScore >= 60) {
              scoreContainer.className = "mb-4 p-4 bg-yellow-100 border-2 border-yellow-400 rounded-lg flex justify-between items-center text-yellow-900";
              scoreDisplay.innerHTML += ' <span class="text-sm font-normal ml-2">ðŸ‘ Good match</span>';
            } else {
              scoreContainer.className = "mb-4 p-4 bg-red-100 border-2 border-red-400 rounded-lg flex justify-between items-center text-red-900";
              scoreDisplay.innerHTML += ' <span class="text-sm font-normal ml-2">âš ï¸ Needs improvement</span>';
            }

            // Change button to show it's done
            if (btnText) btnText.innerText = 'âœ“ Score Checked';
            btn.classList.remove('from-purple-600', 'to-indigo-600');
            btn.classList.add('from-green-500', 'to-emerald-500');
          }

        } catch (error) {
          console.error('Verify score error:', error);
          showToast('âŒ Analysis failed. Please try again.', 'error');
          if (btnText) btnText.innerText = originalText;
          btn.disabled = false;
        }
      });
    }

    // --- Verify Score Button (Footer Version) ---
    function wireVerifyScoreButtonFooter() {
      const btn = document.getElementById('btn-verify-score-footer');
      if (!btn || btn.dataset.wired) return;  // Prevent double-wiring
      btn.dataset.wired = 'true';

      btn.addEventListener('click', async function () {
        const job = window.currentCVJob;
        if (!job) {
          showToast('âŒ No job context found', 'error');
          return;
        }

        // Get the CV text from the preview
        const cvContent = document.getElementById('cv-preview-content');
        const cvText = cvContent ? cvContent.innerText : currentResultText;

        if (!cvText || cvText.length < 50) {
          showToast('âŒ No CV content to analyze', 'error');
          return;
        }

        const jobDescription = job.description || '';
        if (!jobDescription || jobDescription.length < 50) {
          showToast('âš ï¸ Job description too short for analysis', 'error');
          return;
        }

        // Show loading state
        const btnText = document.getElementById('btn-verify-text-footer');
        const originalText = btnText?.innerText || 'Check ATS Score';
        if (btnText) btnText.innerText = 'Analyzing...';
        btn.disabled = true;

        try {
          const response = await fetch('/api/job/analyze-match', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              resume_text: cvText,
              job_description: jobDescription,
              job_title: job.title || 'Position',
              company: job.company || 'Company'
            })
          });

          const data = await response.json();

          // Show the result in the content area
          const scoreContainer = document.getElementById('new-score-container');
          const scoreDisplay = document.getElementById('new-ats-score-display');

          if (scoreContainer && scoreDisplay) {
            const analysis = data.analysis || {};
            const matchScore = analysis.match_score || data.match_score || 50;

            scoreContainer.classList.remove('hidden');
            scoreDisplay.innerHTML = `ðŸš€ <span class="text-2xl">${matchScore}%</span> ATS Match Score`;

            // Visual feedback based on score
            if (matchScore >= 80) {
              scoreContainer.className = "mb-4 p-4 bg-green-100 border-2 border-green-400 rounded-lg flex justify-between items-center text-green-900 animate-pulse";
              scoreDisplay.innerHTML += ' <span class="text-sm font-normal ml-2">âœ¨ Excellent match!</span>';
            } else if (matchScore >= 60) {
              scoreContainer.className = "mb-4 p-4 bg-yellow-100 border-2 border-yellow-400 rounded-lg flex justify-between items-center text-yellow-900";
              scoreDisplay.innerHTML += ' <span class="text-sm font-normal ml-2">ðŸ‘ Good match</span>';
            } else {
              scoreContainer.className = "mb-4 p-4 bg-red-100 border-2 border-red-400 rounded-lg flex justify-between items-center text-red-900";
              scoreDisplay.innerHTML += ' <span class="text-sm font-normal ml-2">âš ï¸ Needs improvement</span>';
            }

            // Update BUTTON to show actual score
            btn.innerHTML = `<i class="fas fa-check-circle"></i> ${matchScore}% Match`;
            btn.disabled = true;
            btn.classList.add('cursor-default');

            // Change button color based on score
            btn.classList.remove('from-purple-600', 'to-indigo-600', 'hover:from-purple-700', 'hover:to-indigo-700');
            if (matchScore >= 80) {
              btn.classList.add('from-green-500', 'to-emerald-500');
            } else if (matchScore >= 60) {
              btn.classList.add('from-yellow-500', 'to-orange-500');
            } else {
              btn.classList.add('from-red-500', 'to-rose-500');
            }
          }

        } catch (error) {
          console.error('Verify score error:', error);
          showToast('âŒ Analysis failed. Please try again.', 'error');
          if (btnText) btnText.innerText = originalText;
          btn.disabled = false;
        }
      });
    }

    // Reset footer when modal closes
    function resetResultModalFooter() {
      const footerVerifyContainer = document.getElementById('footer-verify-container');
      const footerSpacer = document.getElementById('footer-spacer');
      const btn = document.getElementById('btn-verify-score-footer');

      if (footerVerifyContainer) footerVerifyContainer.classList.add('hidden');
      if (footerSpacer) footerSpacer.classList.remove('hidden');
      if (btn) {
        btn.disabled = false;
        btn.dataset.wired = '';
        // Restore original button HTML
        btn.innerHTML = '<i class="fas fa-bolt"></i> <span id="btn-verify-text-footer">Check ATS Score</span>';
        // Remove all score-based colors and restore original
        btn.classList.remove('from-green-500', 'to-emerald-500', 'from-yellow-500', 'to-orange-500', 'from-red-500', 'to-rose-500', 'cursor-default');
        btn.classList.add('from-purple-600', 'to-indigo-600', 'hover:from-purple-700', 'hover:to-indigo-700');
      }
    }

    // --- Utilities ---
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', async () => {
      loadJobs();
      try {
        const res = await fetch('/api/get-profile');
        const data = await res.json();
        updateProfileStatus(data.resume_text);

        // Update user display with email if available
        if (data.user_email) {
          const username = data.user_email.split('@')[0];
          document.getElementById('user-display').textContent = username;
        }

        // Check for First Run Experience - show onboarding if no resume
        if (!data.resume_text || data.resume_text.trim().length === 0) {
          showOnboardingModal();
        }
      } catch (e) {
        console.error('Init error:', e);
      }
    });

    // --- Onboarding Modal Functions ---
    function showOnboardingModal() {
      document.getElementById('onboarding-modal').classList.remove('hidden');
    }

    function closeOnboardingModal() {
      document.getElementById('onboarding-modal').classList.add('hidden');
    }

    function closeOnboardingAndOpenProfile() {
      closeOnboardingModal();
      openProfileModal();
    }

    function triggerOnboardingUpload() {
      // Close the onboarding modal first
      closeOnboardingModal();
      // Open the profile modal
      openProfileModal();
      // Small delay to ensure modal is open, then trigger file input
      setTimeout(() => {
        document.getElementById('pdf-input').click();
      }, 100);
    }

    // Wire up onboarding modal button and file input
    document.addEventListener('DOMContentLoaded', function () {
      const modalUploadBtn = document.getElementById('btn-upload-modal');
      const onboardingInput = document.getElementById('onboarding-resume-input');
      const btnText = document.getElementById('btn-upload-modal-text');

      if (modalUploadBtn && onboardingInput) {
        // Wire button to trigger hidden file input
        modalUploadBtn.addEventListener('click', function () {
          onboardingInput.click();
        });

        // Auto-upload when file is selected
        onboardingInput.addEventListener('change', async function () {
          if (this.files && this.files.length > 0) {
            // Show loading state
            if (btnText) btnText.innerText = "Uploading...";
            modalUploadBtn.disabled = true;

            const file = this.files[0];
            const formData = new FormData();
            formData.append('file', file);

            try {
              const response = await fetch('/api/upload-resume', {
                method: 'POST',
                body: formData
              });
              const result = await response.json();

              if (response.ok) {
                // Success - close modal and reload
                document.getElementById('onboarding-modal').classList.add('hidden');
                window.location.reload();
              } else {
                alert('Upload failed: ' + (result.detail || 'Unknown error'));
                if (btnText) btnText.innerText = "Upload Resume Now";
                modalUploadBtn.disabled = false;
              }
            } catch (error) {
              console.error('Upload error:', error);
              alert('Upload failed. Please try again.');
              if (btnText) btnText.innerText = "Upload Resume Now";
              modalUploadBtn.disabled = false;
            }
          }
        });
      }
    });
  </script>

</body>

</html>