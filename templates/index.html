<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Agent | AI Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    * {
      font-family: 'Inter', sans-serif;
    }

    .card-hover {
      transition: all 0.2s ease;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    }

    .modal-backdrop {
      backdrop-filter: blur(4px);
    }

    .btn-loading {
      pointer-events: none;
      opacity: 0.7;
    }

    .cv-preview {
      font-family: 'Times New Roman', serif;
    }

    .status-badge {
      transition: all 0.15s ease;
    }

    .drop-zone {
      transition: all 0.2s ease;
    }

    .drop-zone:hover {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }

    .drop-zone.dragover {
      border-color: #3b82f6;
      background-color: #dbeafe;
    }

    .tab-active {
      border-bottom: 2px solid #3b82f6;
      color: #3b82f6;
    }

    .tab-inactive {
      border-bottom: 2px solid transparent;
      color: #6b7280;
    }

    .tab-inactive:hover {
      color: #374151;
    }

    /* Heart button styles */
    .heart-btn {
      transition: all 0.2s ease;
    }

    .heart-btn:hover {
      transform: scale(1.1);
    }

    .heart-btn.saved {
      color: #ef4444;
    }

    /* Kanban column styles */
    .kanban-column {
      min-height: 400px;
    }

    .kanban-card {
      transition: all 0.15s ease;
    }

    .kanban-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .move-btn {
      transition: all 0.15s ease;
    }

    .move-btn:hover:not(:disabled) {
      background-color: #e5e7eb;
    }

    .move-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div
            class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl flex items-center justify-center">
            <i class="fas fa-bolt text-white"></i>
          </div>
          <span class="text-xl font-bold text-gray-900">JobAgent</span>
        </div>
        <div class="flex items-center space-x-3">
          <button onclick="loadJobs()" class="px-3 py-2 text-gray-600 hover:text-gray-900 text-sm">
            <i class="fas fa-sync-alt mr-1"></i> Refresh
          </button>
          <button onclick="openProfileModal()"
            class="px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200">
            <i class="fas fa-user mr-1"></i> Profile
          </button>
        </div>
      </div>

      <!-- Search Bar Row -->
      <div class="mt-4 flex flex-col sm:flex-row gap-3">
        <div class="flex-1 relative">
          <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
          <input type="text" id="search-query" placeholder="Search roles... (e.g., AI Engineer)"
            class="w-full pl-11 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
            onkeydown="if(event.key==='Enter') triggerScrape()">
        </div>
        <div class="sm:w-56 relative">
          <i class="fas fa-map-marker-alt absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
          <input type="text" id="search-location" placeholder="Location... (e.g., NYC)"
            class="w-full pl-11 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
            onkeydown="if(event.key==='Enter') triggerScrape()">
        </div>
        <button onclick="triggerScrape()" id="search-btn"
          class="px-6 py-3 bg-blue-600 text-white text-sm font-medium rounded-xl hover:bg-blue-700 transition flex items-center justify-center">
          <i class="fas fa-search mr-2"></i> Search
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-6 py-6">

    <!-- Tabs -->
    <div class="flex items-center space-x-6 border-b border-gray-200 mb-6">
      <button id="tab-feed" onclick="switchTab('feed')" class="pb-3 px-1 font-medium text-sm tab-active">
        <i class="fas fa-rss mr-2"></i> Job Feed
      </button>
      <button id="tab-kanban" onclick="switchTab('kanban')" class="pb-3 px-1 font-medium text-sm tab-inactive">
        <i class="fas fa-columns mr-2"></i> My Applications
      </button>
    </div>

    <!-- Stats Bar -->
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h1 id="page-title" class="text-2xl font-bold text-gray-900">Job Feed</h1>
        <p id="job-count" class="text-gray-500 text-sm">Loading jobs...</p>
      </div>
      <div id="profile-status" class="flex items-center space-x-2 text-sm">
        <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full">
          <i class="fas fa-exclamation-circle mr-1"></i> No Resume
        </span>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-16">
      <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
      <p class="text-gray-500">Loading jobs...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden text-center py-16">
      <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
      <p class="text-gray-700 font-medium">Failed to load jobs</p>
      <p id="error-message" class="text-gray-500 text-sm mt-2"></p>
      <button onclick="loadJobs()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg">Try Again</button>
    </div>

    <!-- Jobs Grid (Job Feed Tab) -->
    <div id="jobs-container" class="hidden grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
      <!-- Jobs inserted here -->
    </div>

    <!-- Kanban Board (My Applications Tab) -->
    <div id="kanban-container" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Saved Column -->
        <div class="kanban-column bg-gray-100 rounded-xl p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-700 flex items-center">
              <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
              Saved
            </h3>
            <span id="saved-count" class="text-xs bg-gray-300 text-gray-700 px-2 py-0.5 rounded-full">0</span>
          </div>
          <div id="kanban-saved" class="space-y-3">
            <!-- Saved jobs here -->
          </div>
        </div>

        <!-- Applied Column -->
        <div class="kanban-column bg-blue-50 rounded-xl p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-blue-700 flex items-center">
              <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
              Applied
            </h3>
            <span id="applied-count" class="text-xs bg-blue-200 text-blue-700 px-2 py-0.5 rounded-full">0</span>
          </div>
          <div id="kanban-applied" class="space-y-3">
            <!-- Applied jobs here -->
          </div>
        </div>

        <!-- Interview Column -->
        <div class="kanban-column bg-purple-50 rounded-xl p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-purple-700 flex items-center">
              <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
              Interview
            </h3>
            <span id="interview-count" class="text-xs bg-purple-200 text-purple-700 px-2 py-0.5 rounded-full">0</span>
          </div>
          <div id="kanban-interview" class="space-y-3">
            <!-- Interview jobs here -->
          </div>
        </div>

        <!-- Offer Column -->
        <div class="kanban-column bg-green-50 rounded-xl p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-green-700 flex items-center">
              <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
              Offer
            </h3>
            <span id="offer-count" class="text-xs bg-green-200 text-green-700 px-2 py-0.5 rounded-full">0</span>
          </div>
          <div id="kanban-offer" class="space-y-3">
            <!-- Offer jobs here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div id="empty" class="hidden text-center py-16">
      <i class="fas fa-briefcase text-4xl text-gray-300 mb-4"></i>
      <p class="text-gray-700 font-medium" id="empty-title">No jobs found</p>
      <p class="text-gray-500 text-sm mt-2" id="empty-subtitle">Use the search bar above to find jobs</p>
    </div>
  </main>

  <!-- ======================== -->
  <!-- PROFILE MODAL -->
  <!-- ======================== -->
  <div id="profile-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0 bg-black/40" onclick="closeProfileModal()"></div>
    <div
      class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
      <div class="flex items-center justify-between p-6 border-b">
        <h2 class="text-xl font-bold text-gray-900">Your Profile</h2>
        <button onclick="closeProfileModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="p-6 max-h-[70vh] overflow-y-auto">

        <!-- PDF Upload Drop Zone -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Upload Resume (PDF)</label>
          <div id="drop-zone"
            class="drop-zone border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer bg-gray-50"
            onclick="document.getElementById('pdf-input').click()">
            <input type="file" id="pdf-input" accept=".pdf" class="hidden" onchange="handlePdfUpload(event)">
            <div id="drop-zone-content">
              <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
              <p class="text-gray-600 font-medium text-sm">Click to upload or drag & drop</p>
              <p class="text-gray-400 text-xs mt-1">PDF files only (max 5MB)</p>
            </div>
            <div id="drop-zone-loading" class="hidden">
              <i class="fas fa-spinner fa-spin text-3xl text-blue-500 mb-2"></i>
              <p class="text-blue-600 font-medium text-sm">Parsing PDF...</p>
            </div>
            <div id="drop-zone-success" class="hidden">
              <i class="fas fa-check-circle text-3xl text-green-500 mb-2"></i>
              <p class="text-green-600 font-medium text-sm">Resume parsed!</p>
              <p id="pdf-filename" class="text-gray-500 text-xs mt-1"></p>
            </div>
          </div>
        </div>

        <!-- Resume Text -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Resume Text</label>
          <textarea id="profile-resume" rows="8"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm max-h-48 overflow-y-auto"
            placeholder="Your resume text will appear here..."></textarea>
        </div>

        <!-- Skills with scroll -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Key Skills (comma-separated)</label>
          <textarea id="profile-skills" rows="2"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm max-h-24 overflow-y-auto"
            placeholder="Python, Machine Learning, FastAPI, SQL..."></textarea>
        </div>
      </div>
      <div class="flex justify-end p-6 border-t bg-gray-50">
        <button onclick="closeProfileModal()" class="px-4 py-2 text-gray-600 mr-3">Cancel</button>
        <button onclick="saveProfile()"
          class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">
          <i class="fas fa-save mr-2"></i> Save
        </button>
      </div>
    </div>
  </div>

  <!-- ======================== -->
  <!-- RESULT MODAL -->
  <!-- ======================== -->
  <div id="result-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0 bg-black/40" onclick="closeResultModal()"></div>
    <div
      class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-3xl bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
      <div class="flex items-center justify-between p-6 border-b shrink-0">
        <h2 id="result-title" class="text-xl font-bold text-gray-900">Result</h2>
        <button onclick="closeResultModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div id="result-content" class="p-6 overflow-y-auto flex-1">
        <!-- Dynamic content -->
      </div>
      <div class="flex justify-end p-4 border-t bg-gray-50 shrink-0">
        <button onclick="copyResultToClipboard()" class="px-4 py-2 text-gray-600 mr-3 hover:bg-gray-100 rounded-lg">
          <i class="fas fa-copy mr-2"></i> Copy
        </button>
        <button onclick="closeResultModal()"
          class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">Done</button>
      </div>
    </div>
  </div>

  <script>
    // =============================================
    // JOB AGENT DASHBOARD 3.0 - HEART/KANBAN
    // =============================================

    let allJobs = [];
    let currentTab = 'feed';
    let currentResultText = '';

    // Kanban statuses in order (for move left/right)
    const KANBAN_STATUSES = ['saved', 'applied', 'interview', 'offer'];

    // --- Salary Formatter ---
    function formatSalary(min, max) {
      if (!min && !max) return null;

      const minVal = parseInt(min) || 0;
      const maxVal = parseInt(max) || 0;

      const format = (val) => {
        if (val >= 1000) {
          return `$${Math.round(val / 1000)}K`;
        }
        return `$${val}`;
      };

      if (!minVal && maxVal) return format(maxVal);
      if (minVal && !maxVal) return format(minVal);
      if (minVal === maxVal) return format(minVal);

      return `${format(minVal)} - ${format(maxVal)}`;
    }

    // --- Tab Switching ---
    function switchTab(tab) {
      currentTab = tab;

      // Update tab UI
      document.getElementById('tab-feed').className = tab === 'feed'
        ? 'pb-3 px-1 font-medium text-sm tab-active'
        : 'pb-3 px-1 font-medium text-sm tab-inactive';
      document.getElementById('tab-kanban').className = tab === 'kanban'
        ? 'pb-3 px-1 font-medium text-sm tab-active'
        : 'pb-3 px-1 font-medium text-sm tab-inactive';

      // Update title
      document.getElementById('page-title').textContent = tab === 'feed'
        ? 'Job Feed'
        : 'My Applications';

      // Toggle containers
      const jobsContainer = document.getElementById('jobs-container');
      const kanbanContainer = document.getElementById('kanban-container');
      const empty = document.getElementById('empty');

      if (tab === 'feed') {
        kanbanContainer.classList.add('hidden');
        renderJobs();
      } else {
        jobsContainer.classList.add('hidden');
        empty.classList.add('hidden');
        renderKanban();
      }
    }

    // --- Load Jobs ---
    async function loadJobs() {
      console.log('üîç Fetching jobs...');
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const container = document.getElementById('jobs-container');
      const kanbanContainer = document.getElementById('kanban-container');
      const empty = document.getElementById('empty');

      loading.classList.remove('hidden');
      error.classList.add('hidden');
      container.classList.add('hidden');
      kanbanContainer.classList.add('hidden');
      empty.classList.add('hidden');

      try {
        const res = await fetch('/jobs');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const jobs = await res.json();
        console.log('‚úÖ Loaded jobs:', jobs.length);
        allJobs = Array.isArray(jobs) ? jobs : [];

        loading.classList.add('hidden');

        if (currentTab === 'feed') {
          renderJobs();
        } else {
          renderKanban();
        }

      } catch (err) {
        console.error('‚ùå', err);
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        document.getElementById('error-message').textContent = err.message;
      }
    }

    // --- Render Jobs (Job Feed - Only Unsaved Jobs) ---
    function renderJobs() {
      const container = document.getElementById('jobs-container');
      const empty = document.getElementById('empty');
      const countEl = document.getElementById('job-count');

      // Job Feed: Show only jobs with status 'new' or no status
      const feedJobs = allJobs.filter(job => !job.status || job.status.toLowerCase() === 'new');

      if (feedJobs.length === 0) {
        container.classList.add('hidden');
        empty.classList.remove('hidden');
        document.getElementById('empty-title').textContent = 'No new jobs found';
        document.getElementById('empty-subtitle').textContent = 'Use the search bar above to find jobs';
        countEl.textContent = '0 jobs';
        return;
      }

      container.innerHTML = feedJobs.map((job) => createFeedCard(job)).join('');
      container.classList.remove('hidden');
      empty.classList.add('hidden');
      countEl.textContent = `${feedJobs.length} job${feedJobs.length !== 1 ? 's' : ''}`;
    }

    // --- Render Kanban Board ---
    function renderKanban() {
      const kanbanContainer = document.getElementById('kanban-container');
      const empty = document.getElementById('empty');
      const countEl = document.getElementById('job-count');

      // Group jobs by status
      const savedJobs = allJobs.filter(j => j.status?.toLowerCase() === 'saved');
      const appliedJobs = allJobs.filter(j => j.status?.toLowerCase() === 'applied');
      const interviewJobs = allJobs.filter(j => j.status?.toLowerCase() === 'interview' || j.status?.toLowerCase() === 'interviewing');
      const offerJobs = allJobs.filter(j => j.status?.toLowerCase() === 'offer');

      const totalTracked = savedJobs.length + appliedJobs.length + interviewJobs.length + offerJobs.length;

      if (totalTracked === 0) {
        kanbanContainer.classList.add('hidden');
        empty.classList.remove('hidden');
        document.getElementById('empty-title').textContent = 'No saved applications yet';
        document.getElementById('empty-subtitle').textContent = 'Click the ‚ù§Ô∏è heart on a job card to start tracking';
        countEl.textContent = '0 tracked';
        return;
      }

      // Populate columns
      document.getElementById('kanban-saved').innerHTML = savedJobs.map(j => createKanbanCard(j, 0)).join('') || '<p class="text-gray-400 text-sm text-center py-4">No jobs</p>';
      document.getElementById('kanban-applied').innerHTML = appliedJobs.map(j => createKanbanCard(j, 1)).join('') || '<p class="text-gray-400 text-sm text-center py-4">No jobs</p>';
      document.getElementById('kanban-interview').innerHTML = interviewJobs.map(j => createKanbanCard(j, 2)).join('') || '<p class="text-gray-400 text-sm text-center py-4">No jobs</p>';
      document.getElementById('kanban-offer').innerHTML = offerJobs.map(j => createKanbanCard(j, 3)).join('') || '<p class="text-gray-400 text-sm text-center py-4">No jobs</p>';

      // Update counts
      document.getElementById('saved-count').textContent = savedJobs.length;
      document.getElementById('applied-count').textContent = appliedJobs.length;
      document.getElementById('interview-count').textContent = interviewJobs.length;
      document.getElementById('offer-count').textContent = offerJobs.length;

      kanbanContainer.classList.remove('hidden');
      empty.classList.add('hidden');
      countEl.textContent = `${totalTracked} tracked`;
    }

    // --- Create Feed Card HTML (Simplified with Heart) ---
    function createFeedCard(job) {
      const title = escapeHtml(job.title || 'Untitled');
      const company = escapeHtml(job.company || 'Unknown');
      const location = escapeHtml(job.location || 'Remote');
      const url = job.url || '#';
      const jobId = job.id;
      const salaryText = formatSalary(job.salary_min, job.salary_max);

      return `
        <div class="card-hover bg-white rounded-xl border border-gray-200 overflow-hidden" data-job-id="${jobId}">
          <div class="p-4">
            <!-- Header -->
            <div class="flex items-start justify-between mb-3">
              <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold shrink-0">
                ${company.charAt(0).toUpperCase()}
              </div>
              <button onclick="toggleSave('${jobId}')" class="heart-btn p-2 text-gray-300 hover:text-red-500 transition" title="Save to My Applications">
                <i class="far fa-heart text-xl"></i>
              </button>
            </div>
            
            <!-- Title & Company -->
            <h3 class="font-semibold text-gray-900 leading-tight mb-1 line-clamp-2">${title}</h3>
            <p class="text-blue-600 font-medium text-sm mb-2">${company}</p>
            
            <!-- Location & Salary Row -->
            <div class="flex items-center justify-between text-sm mb-4">
              <span class="text-gray-500 flex items-center">
                <i class="fas fa-map-marker-alt mr-1.5 text-gray-400 text-xs"></i>
                <span class="truncate max-w-[120px]">${location}</span>
              </span>
              ${salaryText ? `<span class="text-green-600 font-semibold">${salaryText}</span>` : '<span class="text-gray-400 text-xs">Salary not listed</span>'}
            </div>
          </div>
          
          <!-- Action Bar -->
          <div class="bg-gray-50 px-4 py-3 border-t border-gray-100">
            <div class="flex items-center justify-between">
              <button onclick="toggleSave('${jobId}')" class="flex-1 mr-2 py-2 bg-red-50 text-red-600 font-medium rounded-lg hover:bg-red-100 transition flex items-center justify-center">
                <i class="far fa-heart mr-2"></i> Save
              </button>
              <a href="${url}" target="_blank" class="flex-1 py-2 bg-blue-600 text-white text-center font-medium rounded-lg hover:bg-blue-700 transition flex items-center justify-center">
                Apply <i class="fas fa-external-link-alt ml-2"></i>
              </a>
            </div>
          </div>
        </div>
      `;
    }

    // --- Create Kanban Card HTML (Minimal with Move Buttons) ---
    function createKanbanCard(job, columnIndex) {
      const title = escapeHtml(job.title || 'Untitled');
      const company = escapeHtml(job.company || 'Unknown');
      const url = job.url || '#';
      const jobId = job.id;

      const canMoveLeft = columnIndex > 0;
      const canMoveRight = columnIndex < KANBAN_STATUSES.length - 1;

      return `
        <div class="kanban-card bg-white rounded-lg border border-gray-200 p-3 shadow-sm" data-job-id="${jobId}">
          <div class="flex items-start justify-between mb-2">
            <div class="flex-1 min-w-0">
              <h4 class="font-semibold text-gray-900 text-sm leading-tight truncate">${title}</h4>
              <p class="text-blue-600 text-xs font-medium truncate">${company}</p>
            </div>
            <a href="${url}" target="_blank" class="ml-2 text-gray-400 hover:text-blue-500" title="View Job">
              <i class="fas fa-external-link-alt text-xs"></i>
            </a>
          </div>
          
          <!-- Move Buttons -->
          <div class="flex items-center justify-between pt-2 border-t border-gray-100">
            <button onclick="moveJob('${jobId}', -1)" ${!canMoveLeft ? 'disabled' : ''} class="move-btn p-1.5 text-gray-500 rounded hover:text-gray-700" title="Move Left">
              <i class="fas fa-chevron-left text-xs"></i>
            </button>
            <div class="flex gap-1">
              <button onclick="draftEmail('${jobId}')" class="p-1.5 text-gray-400 hover:text-gray-600 rounded" title="Cold Email">
                <i class="fas fa-envelope text-xs"></i>
              </button>
              <button onclick="generateCoverLetter('${jobId}')" class="p-1.5 text-gray-400 hover:text-gray-600 rounded" title="Cover Letter">
                <i class="fas fa-file-signature text-xs"></i>
              </button>
              <button onclick="tailorCV('${jobId}')" class="p-1.5 text-gray-400 hover:text-gray-600 rounded" title="Tailored CV">
                <i class="fas fa-file-alt text-xs"></i>
              </button>
            </div>
            <button onclick="moveJob('${jobId}', 1)" ${!canMoveRight ? 'disabled' : ''} class="move-btn p-1.5 text-gray-500 rounded hover:text-gray-700" title="Move Right">
              <i class="fas fa-chevron-right text-xs"></i>
            </button>
          </div>
        </div>
      `;
    }

    // --- Toggle Save (Heart Button) ---
    async function toggleSave(jobId) {
      const job = allJobs.find(j => j.id === jobId);
      if (!job) return;

      // Set status to 'saved'
      job.status = 'saved';

      // Re-render immediately
      renderJobs();
      showToast('‚ù§Ô∏è Job saved to My Applications!');

      // Persist to backend
      try {
        await fetch('/api/update-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: jobId, status: 'saved' })
        });
      } catch (err) {
        console.log('Status persist skipped:', err);
      }
    }

    // --- Move Job (Arrow Buttons in Kanban) ---
    async function moveJob(jobId, direction) {
      const job = allJobs.find(j => j.id === jobId);
      if (!job) return;

      // Normalize status
      let currentStatus = (job.status || 'saved').toLowerCase();
      if (currentStatus === 'interviewing') currentStatus = 'interview';

      const currentIndex = KANBAN_STATUSES.indexOf(currentStatus);
      const newIndex = currentIndex + direction;

      if (newIndex < 0 || newIndex >= KANBAN_STATUSES.length) return;

      const newStatus = KANBAN_STATUSES[newIndex];
      job.status = newStatus;

      // Re-render kanban
      renderKanban();

      const statusEmojis = { 'saved': 'üìå', 'applied': 'üì§', 'interview': 'üé§', 'offer': 'üéâ' };
      showToast(`${statusEmojis[newStatus] || '‚úì'} Moved to ${newStatus.charAt(0).toUpperCase() + newStatus.slice(1)}`);

      // Persist to backend
      try {
        await fetch('/api/update-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: jobId, status: newStatus })
        });
      } catch (err) {
        console.log('Status persist skipped:', err);
      }
    }

    // --- Trigger Scrape ---
    async function triggerScrape() {
      const queryInput = document.getElementById('search-query');
      const locationInput = document.getElementById('search-location');
      const btn = document.getElementById('search-btn');

      const query = queryInput.value.trim();
      const location = locationInput.value.trim();

      if (!query) {
        queryInput.focus();
        queryInput.classList.add('ring-2', 'ring-red-500');
        setTimeout(() => queryInput.classList.remove('ring-2', 'ring-red-500'), 2000);
        return;
      }

      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Searching...';
      btn.disabled = true;

      try {
        let url = `/jobs/scrape-sync?query=${encodeURIComponent(query)}`;
        if (location) url += `&location=${encodeURIComponent(location)}`;

        const res = await fetch(url, { method: 'POST' });
        const data = await res.json();

        const added = data.added || 0;
        const loc = data.location || location || 'any location';
        showToast(`‚úÖ Found ${added} new jobs for "${query}" in ${loc}!`);

        // Switch to feed tab and reload
        currentTab = 'feed';
        switchTab('feed');
        loadJobs();
      } catch (err) {
        showToast(`‚ùå Search failed: ${err.message}`, 'error');
      } finally {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
      }
    }

    // --- Toast Notification ---
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `fixed bottom-6 right-6 px-5 py-3 rounded-xl shadow-lg text-white font-medium z-50 transition-all text-sm ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // --- PDF Upload Handler ---
    async function handlePdfUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.name.toLowerCase().endsWith('.pdf')) {
        showToast('Please upload a PDF file.', 'error');
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        showToast('File too large. Max 5MB.', 'error');
        return;
      }

      document.getElementById('drop-zone-content').classList.add('hidden');
      document.getElementById('drop-zone-success').classList.add('hidden');
      document.getElementById('drop-zone-loading').classList.remove('hidden');

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch('/api/upload-resume', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (data.text) {
          document.getElementById('profile-resume').value = data.text;
          if (data.skills) {
            document.getElementById('profile-skills').value = data.skills;
          }

          document.getElementById('drop-zone-loading').classList.add('hidden');
          document.getElementById('drop-zone-success').classList.remove('hidden');
          document.getElementById('pdf-filename').textContent = file.name;
        } else {
          throw new Error(data.error || 'Failed to parse PDF');
        }
      } catch (err) {
        showToast('Failed to parse PDF: ' + err.message, 'error');
        document.getElementById('drop-zone-loading').classList.add('hidden');
        document.getElementById('drop-zone-content').classList.remove('hidden');
      }
    }

    // --- Drag and Drop for PDF ---
    document.addEventListener('DOMContentLoaded', () => {
      const dropZone = document.getElementById('drop-zone');

      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          dropZone.classList.add('dragover');
        });
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          dropZone.classList.remove('dragover');
        });
      });

      dropZone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          document.getElementById('pdf-input').files = files;
          handlePdfUpload({ target: { files: files } });
        }
      });
    });

    // --- AI Feature Functions ---
    async function draftEmail(jobId) {
      const btn = document.getElementById(`btn-email-${jobId}`);
      const originalHTML = btn?.innerHTML;
      if (btn) {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.classList.add('btn-loading');
      }

      try {
        const res = await fetch('/api/generate-cold-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ job_id: jobId })
        });
        const data = await res.json();

        if (data.error && data.error !== "Parsing failed") {
          showResult('Error', `<p class="text-red-600">${escapeHtml(data.error)}</p>`);
        } else {
          const subject = escapeHtml(data.subject || 'No subject');
          const body = escapeHtml(data.body || 'No content').replace(/\n/g, '<br>');
          currentResultText = `Subject: ${data.subject}\n\n${data.body}`;
          showResult('üìß Cold Email', `
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-500 mb-1">Subject</label>
                            <p class="text-lg font-semibold text-gray-900">${subject}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-500 mb-1">Body</label>
                            <div class="bg-gray-50 rounded-lg p-4 text-gray-800 leading-relaxed">${body}</div>
                        </div>
                    `);
        }
      } catch (err) {
        showResult('Error', `<p class="text-red-600">${err.message}</p>`);
      } finally {
        if (btn && originalHTML) {
          btn.innerHTML = originalHTML;
          btn.classList.remove('btn-loading');
        }
      }
    }

    async function generateCoverLetter(jobId) {
      const btn = document.getElementById(`btn-cover-${jobId}`);
      const originalHTML = btn?.innerHTML;
      if (btn) {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.classList.add('btn-loading');
      }

      try {
        const res = await fetch('/api/generate-cover-letter', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ job_id: jobId })
        });
        const data = await res.json();

        if (data.error && !data.full_letter) {
          showResult('Error', `<p class="text-red-600">${escapeHtml(data.error)}</p>`);
        } else {
          const letter = data.full_letter || `${data.greeting || ''}\n\n${data.body || ''}\n\n${data.closing || ''}`;
          currentResultText = letter;
          showResult('üìù Cover Letter', `
                        <div class="bg-gray-50 rounded-lg p-6 text-gray-800 leading-relaxed whitespace-pre-wrap">${escapeHtml(letter)}</div>
                    `);
        }
      } catch (err) {
        showResult('Error', `<p class="text-red-600">${err.message}</p>`);
      } finally {
        if (btn && originalHTML) {
          btn.innerHTML = originalHTML;
          btn.classList.remove('btn-loading');
        }
      }
    }

    async function tailorCV(jobId) {
      const btn = document.getElementById(`btn-cv-${jobId}`);
      const originalHTML = btn?.innerHTML;
      if (btn) {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.classList.add('btn-loading');
      }

      try {
        const res = await fetch('/api/generate-curated-cv', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ job_id: jobId, gap_answers: [] })
        });
        const data = await res.json();

        if (data.error) {
          showResult('Error', `<p class="text-red-600">${escapeHtml(data.error)}</p>`);
        } else {
          currentResultText = data.cv_html || '';
          showResult('üìÑ Tailored CV', `
                        <div class="bg-white border rounded-lg p-6 cv-preview overflow-auto max-h-[60vh]">
                            ${data.cv_html || '<p class="text-gray-500">No CV generated</p>'}
                        </div>
                    `);
        }
      } catch (err) {
        showResult('Error', `<p class="text-red-600">${err.message}</p>`);
      } finally {
        if (btn && originalHTML) {
          btn.innerHTML = originalHTML;
          btn.classList.remove('btn-loading');
        }
      }
    }

    async function startInterview(jobId) {
      const btn = document.getElementById(`btn-interview-${jobId}`);
      const originalHTML = btn?.innerHTML;
      if (btn) {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.classList.add('btn-loading');
      }

      try {
        const res = await fetch('/api/interview/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ job_id: jobId })
        });
        const data = await res.json();

        if (data.error) {
          showResult('Error', `<p class="text-red-600">${escapeHtml(data.error)}</p>`);
        } else {
          currentResultText = data.question || '';
          showResult(`üé§ Interview: ${escapeHtml(data.job_title)}`, `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-5 mb-4">
                            <p class="text-sm text-blue-600 font-medium mb-2">Interviewer:</p>
                            <p class="text-lg text-gray-900">${escapeHtml(data.question)}</p>
                        </div>
                        <p class="text-sm text-gray-500"><i class="fas fa-lightbulb mr-1 text-yellow-500"></i> Practice using the STAR method.</p>
                    `);
        }
      } catch (err) {
        showResult('Error', `<p class="text-red-600">${err.message}</p>`);
      } finally {
        if (btn && originalHTML) {
          btn.innerHTML = originalHTML;
          btn.classList.remove('btn-loading');
        }
      }
    }

    // --- Profile Modal ---
    async function openProfileModal() {
      document.getElementById('profile-modal').classList.remove('hidden');

      document.getElementById('drop-zone-content').classList.remove('hidden');
      document.getElementById('drop-zone-loading').classList.add('hidden');
      document.getElementById('drop-zone-success').classList.add('hidden');

      try {
        const res = await fetch('/api/get-profile');
        const data = await res.json();
        document.getElementById('profile-resume').value = data.resume_text || '';
        document.getElementById('profile-skills').value = data.skills || '';

        if (data.resume_text && data.resume_text.length > 100) {
          document.getElementById('drop-zone-content').classList.add('hidden');
          document.getElementById('drop-zone-success').classList.remove('hidden');
          document.getElementById('pdf-filename').textContent = 'Resume loaded';
        }
      } catch (err) { }
    }

    function closeProfileModal() {
      document.getElementById('profile-modal').classList.add('hidden');
    }

    async function saveProfile() {
      const resume = document.getElementById('profile-resume').value;
      const skills = document.getElementById('profile-skills').value;

      try {
        await fetch('/api/save-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ resume_text: resume, skills: skills })
        });
        closeProfileModal();
        updateProfileStatus(resume);
        showToast('‚úÖ Profile saved!');
      } catch (err) {
        showToast('‚ùå Failed to save', 'error');
      }
    }

    function updateProfileStatus(resumeText) {
      const el = document.getElementById('profile-status');
      if (resumeText && resumeText.length > 50) {
        el.innerHTML = `<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs"><i class="fas fa-check-circle mr-1"></i> Resume Loaded</span>`;
      } else {
        el.innerHTML = `<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs"><i class="fas fa-exclamation-circle mr-1"></i> No Resume</span>`;
      }
    }

    // --- Result Modal ---
    function showResult(title, content) {
      document.getElementById('result-title').textContent = title;
      document.getElementById('result-content').innerHTML = content;
      document.getElementById('result-modal').classList.remove('hidden');
    }

    function closeResultModal() {
      document.getElementById('result-modal').classList.add('hidden');
    }

    function copyResultToClipboard() {
      if (currentResultText) {
        navigator.clipboard.writeText(currentResultText);
        showToast('‚úÖ Copied!');
      }
    }

    // --- Utilities ---
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', async () => {
      loadJobs();
      try {
        const res = await fetch('/api/get-profile');
        const data = await res.json();
        updateProfileStatus(data.resume_text);
      } catch (e) { }
    });
  </script>

</body>

</html>