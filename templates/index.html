<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Agent | AI Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    * {
      font-family: 'Inter', sans-serif;
    }

    .card-hover {
      transition: all 0.2s ease;
    }

    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    }

    .modal-backdrop {
      backdrop-filter: blur(4px);
    }

    .btn-loading {
      pointer-events: none;
      opacity: 0.7;
    }

    .cv-preview {
      font-family: 'Times New Roman', serif;
    }

    .status-badge {
      transition: all 0.15s ease;
    }

    .drop-zone {
      transition: all 0.2s ease;
    }

    .drop-zone:hover {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }

    .drop-zone.dragover {
      border-color: #3b82f6;
      background-color: #dbeafe;
    }

    .tab-active {
      border-bottom: 2px solid #3b82f6;
      color: #3b82f6;
    }

    .tab-inactive {
      border-bottom: 2px solid transparent;
      color: #6b7280;
    }

    .tab-inactive:hover {
      color: #374151;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div
            class="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl flex items-center justify-center">
            <i class="fas fa-bolt text-white"></i>
          </div>
          <span class="text-xl font-bold text-gray-900">JobAgent</span>
        </div>
        <div class="flex items-center space-x-3">
          <button onclick="loadJobs()" class="px-3 py-2 text-gray-600 hover:text-gray-900 text-sm">
            <i class="fas fa-sync-alt mr-1"></i> Refresh
          </button>
          <button onclick="openProfileModal()"
            class="px-4 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200">
            <i class="fas fa-user mr-1"></i> Profile
          </button>
        </div>
      </div>

      <!-- Search Bar Row -->
      <div class="mt-4 flex flex-col sm:flex-row gap-3">
        <div class="flex-1 relative">
          <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
          <input type="text" id="search-query" placeholder="Search roles... (e.g., AI Engineer)"
            class="w-full pl-11 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
            onkeydown="if(event.key==='Enter') triggerScrape()">
        </div>
        <div class="sm:w-56 relative">
          <i class="fas fa-map-marker-alt absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
          <input type="text" id="search-location" placeholder="Location... (e.g., NYC)"
            class="w-full pl-11 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
            onkeydown="if(event.key==='Enter') triggerScrape()">
        </div>
        <button onclick="triggerScrape()" id="search-btn"
          class="px-6 py-3 bg-blue-600 text-white text-sm font-medium rounded-xl hover:bg-blue-700 transition flex items-center justify-center">
          <i class="fas fa-search mr-2"></i> Search
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-6 py-6">

    <!-- Tabs -->
    <div class="flex items-center space-x-6 border-b border-gray-200 mb-6">
      <button id="tab-new" onclick="switchTab('new')" class="pb-3 px-1 font-medium text-sm tab-active">
        <i class="fas fa-search mr-2"></i> New Search
      </button>
      <button id="tab-saved" onclick="switchTab('saved')" class="pb-3 px-1 font-medium text-sm tab-inactive">
        <i class="fas fa-folder mr-2"></i> Saved & Applied
      </button>
    </div>

    <!-- Stats Bar -->
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h1 id="page-title" class="text-2xl font-bold text-gray-900">Job Dashboard</h1>
        <p id="job-count" class="text-gray-500 text-sm">Loading jobs...</p>
      </div>
      <div id="profile-status" class="flex items-center space-x-2 text-sm">
        <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full">
          <i class="fas fa-exclamation-circle mr-1"></i> No Resume
        </span>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-16">
      <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
      <p class="text-gray-500">Loading jobs...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden text-center py-16">
      <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
      <p class="text-gray-700 font-medium">Failed to load jobs</p>
      <p id="error-message" class="text-gray-500 text-sm mt-2"></p>
      <button onclick="loadJobs()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg">Try Again</button>
    </div>

    <!-- Jobs Grid -->
    <div id="jobs-container" class="hidden grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
      <!-- Jobs inserted here -->
    </div>

    <!-- Empty State -->
    <div id="empty" class="hidden text-center py-16">
      <i class="fas fa-briefcase text-4xl text-gray-300 mb-4"></i>
      <p class="text-gray-700 font-medium" id="empty-title">No jobs found</p>
      <p class="text-gray-500 text-sm mt-2" id="empty-subtitle">Use the search bar above to find jobs</p>
    </div>
  </main>

  <!-- ======================== -->
  <!-- PROFILE MODAL -->
  <!-- ======================== -->
  <div id="profile-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0 bg-black/40" onclick="closeProfileModal()"></div>
    <div
      class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden">
      <div class="flex items-center justify-between p-6 border-b">
        <h2 class="text-xl font-bold text-gray-900">Your Profile</h2>
        <button onclick="closeProfileModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="p-6 max-h-[70vh] overflow-y-auto">

        <!-- PDF Upload Drop Zone -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Upload Resume (PDF)</label>
          <div id="drop-zone"
            class="drop-zone border-2 border-dashed border-gray-300 rounded-xl p-6 text-center cursor-pointer bg-gray-50"
            onclick="document.getElementById('pdf-input').click()">
            <input type="file" id="pdf-input" accept=".pdf" class="hidden" onchange="handlePdfUpload(event)">
            <div id="drop-zone-content">
              <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
              <p class="text-gray-600 font-medium text-sm">Click to upload or drag & drop</p>
              <p class="text-gray-400 text-xs mt-1">PDF files only (max 5MB)</p>
            </div>
            <div id="drop-zone-loading" class="hidden">
              <i class="fas fa-spinner fa-spin text-3xl text-blue-500 mb-2"></i>
              <p class="text-blue-600 font-medium text-sm">Parsing PDF...</p>
            </div>
            <div id="drop-zone-success" class="hidden">
              <i class="fas fa-check-circle text-3xl text-green-500 mb-2"></i>
              <p class="text-green-600 font-medium text-sm">Resume parsed!</p>
              <p id="pdf-filename" class="text-gray-500 text-xs mt-1"></p>
            </div>
          </div>
        </div>

        <!-- Resume Text -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Resume Text</label>
          <textarea id="profile-resume" rows="8"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm max-h-48 overflow-y-auto"
            placeholder="Your resume text will appear here..."></textarea>
        </div>

        <!-- Skills with scroll -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Key Skills (comma-separated)</label>
          <textarea id="profile-skills" rows="2"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm max-h-24 overflow-y-auto"
            placeholder="Python, Machine Learning, FastAPI, SQL..."></textarea>
        </div>
      </div>
      <div class="flex justify-end p-6 border-t bg-gray-50">
        <button onclick="closeProfileModal()" class="px-4 py-2 text-gray-600 mr-3">Cancel</button>
        <button onclick="saveProfile()"
          class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">
          <i class="fas fa-save mr-2"></i> Save
        </button>
      </div>
    </div>
  </div>

  <!-- ======================== -->
  <!-- RESULT MODAL -->
  <!-- ======================== -->
  <div id="result-modal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0 bg-black/40" onclick="closeResultModal()"></div>
    <div
      class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-3xl bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
      <div class="flex items-center justify-between p-6 border-b shrink-0">
        <h2 id="result-title" class="text-xl font-bold text-gray-900">Result</h2>
        <button onclick="closeResultModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div id="result-content" class="p-6 overflow-y-auto flex-1">
        <!-- Dynamic content -->
      </div>
      <div class="flex justify-end p-4 border-t bg-gray-50 shrink-0">
        <button onclick="copyResultToClipboard()" class="px-4 py-2 text-gray-600 mr-3 hover:bg-gray-100 rounded-lg">
          <i class="fas fa-copy mr-2"></i> Copy
        </button>
        <button onclick="closeResultModal()"
          class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700">Done</button>
      </div>
    </div>
  </div>

  <script>
    // =============================================
    // JOB AGENT DASHBOARD 2.0
    // =============================================

    let allJobs = [];
    let currentTab = 'new';
    let currentResultText = '';

    // --- Status Colors ---
    const statusColors = {
      'new': 'bg-blue-100 text-blue-700',
      'saved': 'bg-gray-100 text-gray-700',
      'applied': 'bg-green-100 text-green-700',
      'interviewing': 'bg-purple-100 text-purple-700',
      'offer': 'bg-yellow-100 text-yellow-700',
      'rejected': 'bg-red-100 text-red-700',
    };

    // --- Salary Formatter ---
    function formatSalary(min, max) {
      // Handle null/undefined
      if (!min && !max) return null;

      // Convert to numbers
      const minVal = parseInt(min) || 0;
      const maxVal = parseInt(max) || 0;

      // Format helper
      const format = (val) => {
        if (val >= 1000) {
          return `$${Math.round(val / 1000)}K`;
        }
        return `$${val}`;
      };

      // If only one value or they're equal
      if (!minVal && maxVal) return format(maxVal);
      if (minVal && !maxVal) return format(minVal);
      if (minVal === maxVal) return format(minVal);

      // Range
      return `${format(minVal)} - ${format(maxVal)}`;
    }

    // --- Tab Switching ---
    function switchTab(tab) {
      currentTab = tab;

      // Update tab UI
      document.getElementById('tab-new').className = tab === 'new'
        ? 'pb-3 px-1 font-medium text-sm tab-active'
        : 'pb-3 px-1 font-medium text-sm tab-inactive';
      document.getElementById('tab-saved').className = tab === 'saved'
        ? 'pb-3 px-1 font-medium text-sm tab-active'
        : 'pb-3 px-1 font-medium text-sm tab-inactive';

      // Update title
      document.getElementById('page-title').textContent = tab === 'new'
        ? 'Job Dashboard'
        : 'Saved & Applied Jobs';

      renderJobs();
    }

    // --- Load Jobs ---
    async function loadJobs() {
      console.log('üîç Fetching jobs...');
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const container = document.getElementById('jobs-container');
      const empty = document.getElementById('empty');

      loading.classList.remove('hidden');
      error.classList.add('hidden');
      container.classList.add('hidden');
      empty.classList.add('hidden');

      try {
        const res = await fetch('/jobs');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const jobs = await res.json();
        console.log('‚úÖ Loaded jobs:', jobs.length);
        allJobs = Array.isArray(jobs) ? jobs : [];

        loading.classList.add('hidden');
        renderJobs();

      } catch (err) {
        console.error('‚ùå', err);
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        document.getElementById('error-message').textContent = err.message;
      }
    }

    // --- Render Jobs (Filtered by Tab) ---
    function renderJobs() {
      const container = document.getElementById('jobs-container');
      const empty = document.getElementById('empty');
      const countEl = document.getElementById('job-count');

      // Filter based on tab
      let filteredJobs;
      if (currentTab === 'new') {
        // New Search: Show all jobs OR jobs with status 'new'
        filteredJobs = allJobs.filter(job => !job.status || job.status.toLowerCase() === 'new');
      } else {
        // Saved & Applied: Show jobs with status != 'new'
        filteredJobs = allJobs.filter(job => job.status && job.status.toLowerCase() !== 'new');
      }

      if (filteredJobs.length === 0) {
        container.classList.add('hidden');
        empty.classList.remove('hidden');

        if (currentTab === 'new') {
          document.getElementById('empty-title').textContent = 'No new jobs found';
          document.getElementById('empty-subtitle').textContent = 'Use the search bar above to find jobs';
        } else {
          document.getElementById('empty-title').textContent = 'No saved jobs yet';
          document.getElementById('empty-subtitle').textContent = 'Change a job\'s status to "Saved" or "Applied" to see it here';
        }

        countEl.textContent = '0 jobs';
        return;
      }

      container.innerHTML = filteredJobs.map((job, i) => createJobCard(job, i)).join('');
      container.classList.remove('hidden');
      empty.classList.add('hidden');
      countEl.textContent = `${filteredJobs.length} job${filteredJobs.length !== 1 ? 's' : ''}`;
    }

    // --- Create Job Card HTML ---
    function createJobCard(job, index) {
      const title = escapeHtml(job.title || 'Untitled');
      const company = escapeHtml(job.company || 'Unknown');
      const location = escapeHtml(job.location || 'Remote');
      const url = job.url || '#';
      const source = escapeHtml(job.source || 'Manual');
      const isRemote = job.is_remote;
      const jobId = job.id;
      const status = (job.status || 'new').toLowerCase();
      const statusColor = statusColors[status] || statusColors['new'];

      // Format salary
      const salaryText = formatSalary(job.salary_min, job.salary_max);

      return `
                <div class="card-hover bg-white rounded-xl border border-gray-200 overflow-hidden" data-job-id="${jobId}">
                    <div class="p-4">
                        <!-- Header -->
                        <div class="flex items-start justify-between mb-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold shrink-0">
                                ${company.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex items-center gap-1.5 flex-wrap justify-end">
                                ${isRemote ? '<span class="px-2 py-0.5 bg-green-100 text-green-700 text-xs font-medium rounded-full">Remote</span>' : ''}
                                <span class="px-2 py-0.5 bg-gray-100 text-gray-500 text-xs rounded-full">${source}</span>
                            </div>
                        </div>
                        
                        <!-- Title & Company -->
                        <h3 class="font-semibold text-gray-900 leading-tight mb-1 line-clamp-2">${title}</h3>
                        <p class="text-blue-600 font-medium text-sm mb-2">${company}</p>
                        
                        <!-- Location & Salary Row -->
                        <div class="flex items-center justify-between text-sm mb-3">
                            <span class="text-gray-500 flex items-center">
                                <i class="fas fa-map-marker-alt mr-1.5 text-gray-400 text-xs"></i>
                                <span class="truncate max-w-[120px]">${location}</span>
                            </span>
                            ${salaryText ? `<span class="text-green-600 font-semibold">${salaryText}</span>` : '<span class="text-gray-400 text-xs">Salary not listed</span>'}
                        </div>
                        
                        <!-- Status Dropdown -->
                        <select id="status-${jobId}" onchange="updateJobStatus('${jobId}', this.value)" class="status-badge w-full px-3 py-1.5 text-xs font-medium rounded-lg border-0 cursor-pointer ${statusColor}">
                            <option value="new" ${status === 'new' ? 'selected' : ''}>üÜï New</option>
                            <option value="saved" ${status === 'saved' ? 'selected' : ''}>üìå Saved</option>
                            <option value="applied" ${status === 'applied' ? 'selected' : ''}>‚úÖ Applied</option>
                            <option value="interviewing" ${status === 'interviewing' ? 'selected' : ''}>üé§ Interviewing</option>
                            <option value="offer" ${status === 'offer' ? 'selected' : ''}>üéâ Offer</option>
                            <option value="rejected" ${status === 'rejected' ? 'selected' : ''}>‚ùå Rejected</option>
                        </select>
                    </div>
                    
                    <!-- Action Bar -->
                    <div class="bg-gray-50 px-4 py-2.5 border-t border-gray-100">
                        <div class="flex items-center justify-between">
                            <div class="flex gap-1.5">
                                <button onclick="draftEmail('${jobId}')" id="btn-email-${jobId}" class="p-2 bg-white border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition" title="Cold Email">
                                    <i class="fas fa-envelope text-xs"></i>
                                </button>
                                <button onclick="generateCoverLetter('${jobId}')" id="btn-cover-${jobId}" class="p-2 bg-white border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition" title="Cover Letter">
                                    <i class="fas fa-file-signature text-xs"></i>
                                </button>
                                <button onclick="tailorCV('${jobId}')" id="btn-cv-${jobId}" class="p-2 bg-white border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition" title="Tailored CV">
                                    <i class="fas fa-file-alt text-xs"></i>
                                </button>
                                <button onclick="startInterview('${jobId}')" id="btn-interview-${jobId}" class="p-2 bg-white border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition" title="Interview Prep">
                                    <i class="fas fa-microphone text-xs"></i>
                                </button>
                            </div>
                            <a href="${url}" target="_blank" class="px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-lg hover:bg-blue-700 transition">
                                Apply <i class="fas fa-external-link-alt ml-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
            `;
    }

    // --- Update Job Status ---
    async function updateJobStatus(jobId, status) {
      const select = document.getElementById(`status-${jobId}`);
      const statusColor = statusColors[status] || statusColors['new'];
      select.className = `status-badge w-full px-3 py-1.5 text-xs font-medium rounded-lg border-0 cursor-pointer ${statusColor}`;

      // Update local data
      const job = allJobs.find(j => j.id === jobId);
      if (job) job.status = status;

      // Re-render if status change affects current tab view
      setTimeout(() => renderJobs(), 300);

      // Persist to backend
      try {
        await fetch('/api/update-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: jobId, status: status })
        });
      } catch (err) {
        console.log('Status persist skipped');
      }
    }

    // --- Trigger Scrape ---
    async function triggerScrape() {
      const queryInput = document.getElementById('search-query');
      const locationInput = document.getElementById('search-location');
      const btn = document.getElementById('search-btn');

      const query = queryInput.value.trim();
      const location = locationInput.value.trim();

      if (!query) {
        queryInput.focus();
        queryInput.classList.add('ring-2', 'ring-red-500');
        setTimeout(() => queryInput.classList.remove('ring-2', 'ring-red-500'), 2000);
        return;
      }

      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Searching...';
      btn.disabled = true;

      try {
        let url = `/jobs/scrape-sync?query=${encodeURIComponent(query)}`;
        if (location) url += `&location=${encodeURIComponent(location)}`;

        const res = await fetch(url, { method: 'POST' });
        const data = await res.json();

        const added = data.added || 0;
        const loc = data.location || location || 'any location';
        showToast(`‚úÖ Found ${added} new jobs for "${query}" in ${loc}!`);

        // Switch to new tab and reload
        currentTab = 'new';
        switchTab('new');
        loadJobs();
      } catch (err) {
        showToast(`‚ùå Search failed: ${err.message}`, 'error');
      } finally {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
      }
    }

    // --- Toast Notification ---
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `fixed bottom-6 right-6 px-5 py-3 rounded-xl shadow-lg text-white font-medium z-50 transition-all text-sm ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // --- PDF Upload Handler ---
    async function handlePdfUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.name.toLowerCase().endsWith('.pdf')) {
        showToast('Please upload a PDF file.', 'error');
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        showToast('File too large. Max 5MB.', 'error');
        return;
      }

      document.getElementById('drop-zone-content').classList.add('hidden');
      document.getElementById('drop-zone-success').classList.add('hidden');
      document.getElementById('drop-zone-loading').classList.remove('hidden');

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch('/api/upload-resume', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (data.text) {
          document.getElementById('profile-resume').value = data.text;
          if (data.skills) {
            document.getElementById('profile-skills').value = data.skills;
          }

          document.getElementById('drop-zone-loading').classList.add('hidden');
          document.getElementById('drop-zone-success').classList.remove('hidden');
          document.getElementById('pdf-filename').textContent = file.name;
        } else {
          throw new Error(data.error || 'Failed to parse PDF');
        }
      } catch (err) {
        showToast('Failed to parse PDF: ' + err.message, 'error');
        document.getElementById('drop-zone-loading').classList.add('hidden');
        document.getElementById('drop-zone-content').classList.remove('hidden');
      }
    }

    // --- Drag and Drop for PDF ---
    document.addEventListener('DOMContentLoaded', () => {
      const dropZone = document.getElementById('drop-zone');

      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          dropZone.classList.add('dragover');
        });
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
          e.preventDefault();
          dropZone.classList.remove('dragover');
        });
      });

      dropZone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          document.getElementById('pdf-input').files = files;
          handlePdfUpload({ target: { files: files } });
        }
      });
    });

    // --- AI Feature Functions ---
    async function draftEmail(jobId) {
      const btn = document.getElementById(`btn-email-${jobId}`);
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      btn.classList.add('btn-loading');

      try {
        const res = await fetch('/api/generate-cold-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ job_id: jobId })
        });
        const data = await res.json();

        if (data.error && data.error !== "Parsing failed") {
          showResult('Error', `<p class="text-red-600">${escapeHtml(data.error)}</p>`);
        } else {
          const subject = escapeHtml(data.subject || 'No subject');
          const body = escapeHtml(data.body || 'No content').replace(/\n/g, '<br>');
          currentResultText = `Subject: ${data.subject}\n\n${data.body}`;
          showResult('üìß Cold Email', `
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-500 mb-1">Subject</label>
                            <p class="text-lg font-semibold text-gray-900">${subject}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-500 mb-1">Body</label>
                            <div class="bg-gray-50 rounded-lg p-4 text-gray-800 leading-relaxed">${body}</div>
                        </div>
                    `);
        }
      } catch (err) {
        showResult('Error', `<p class="text-red-600">${err.message}</p>`);
      } finally {
        btn.innerHTML = originalHTML;
        btn.classList.remove('btn-loading');
      }
    }

    async function generateCoverLetter(jobId) {
      const btn = document.getElementById(`btn-cover-${jobId}`);
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      btn.classList.add('btn-loading');

      try {
        const res = await fetch('/api/generate-cover-letter', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ job_id: jobId })
        });
        const data = await res.json();

        if (data.error && !data.full_letter) {
          showResult('Error', `<p class="text-red-600">${escapeHtml(data.error)}</p>`);
        } else {
          const letter = data.full_letter || `${data.greeting || ''}\n\n${data.body || ''}\n\n${data.closing || ''}`;
          currentResultText = letter;
          showResult('üìù Cover Letter', `
                        <div class="bg-gray-50 rounded-lg p-6 text-gray-800 leading-relaxed whitespace-pre-wrap">${escapeHtml(letter)}</div>
                    `);
        }
      } catch (err) {
        showResult('Error', `<p class="text-red-600">${err.message}</p>`);
      } finally {
        btn.innerHTML = originalHTML;
        btn.classList.remove('btn-loading');
      }
    }

    async function tailorCV(jobId) {
      const btn = document.getElementById(`btn-cv-${jobId}`);
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      btn.classList.add('btn-loading');

      try {
        const res = await fetch('/api/generate-curated-cv', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ job_id: jobId, gap_answers: [] })
        });
        const data = await res.json();

        if (data.error) {
          showResult('Error', `<p class="text-red-600">${escapeHtml(data.error)}</p>`);
        } else {
          currentResultText = data.cv_html || '';
          showResult('üìÑ Tailored CV', `
                        <div class="bg-white border rounded-lg p-6 cv-preview overflow-auto max-h-[60vh]">
                            ${data.cv_html || '<p class="text-gray-500">No CV generated</p>'}
                        </div>
                    `);
        }
      } catch (err) {
        showResult('Error', `<p class="text-red-600">${err.message}</p>`);
      } finally {
        btn.innerHTML = originalHTML;
        btn.classList.remove('btn-loading');
      }
    }

    async function startInterview(jobId) {
      const btn = document.getElementById(`btn-interview-${jobId}`);
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      btn.classList.add('btn-loading');

      try {
        const res = await fetch('/api/interview/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ job_id: jobId })
        });
        const data = await res.json();

        if (data.error) {
          showResult('Error', `<p class="text-red-600">${escapeHtml(data.error)}</p>`);
        } else {
          currentResultText = data.question || '';
          showResult(`üé§ Interview: ${escapeHtml(data.job_title)}`, `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-5 mb-4">
                            <p class="text-sm text-blue-600 font-medium mb-2">Interviewer:</p>
                            <p class="text-lg text-gray-900">${escapeHtml(data.question)}</p>
                        </div>
                        <p class="text-sm text-gray-500"><i class="fas fa-lightbulb mr-1 text-yellow-500"></i> Practice using the STAR method.</p>
                    `);
        }
      } catch (err) {
        showResult('Error', `<p class="text-red-600">${err.message}</p>`);
      } finally {
        btn.innerHTML = originalHTML;
        btn.classList.remove('btn-loading');
      }
    }

    // --- Profile Modal ---
    async function openProfileModal() {
      document.getElementById('profile-modal').classList.remove('hidden');

      document.getElementById('drop-zone-content').classList.remove('hidden');
      document.getElementById('drop-zone-loading').classList.add('hidden');
      document.getElementById('drop-zone-success').classList.add('hidden');

      try {
        const res = await fetch('/api/get-profile');
        const data = await res.json();
        document.getElementById('profile-resume').value = data.resume_text || '';
        document.getElementById('profile-skills').value = data.skills || '';

        if (data.resume_text && data.resume_text.length > 100) {
          document.getElementById('drop-zone-content').classList.add('hidden');
          document.getElementById('drop-zone-success').classList.remove('hidden');
          document.getElementById('pdf-filename').textContent = 'Resume loaded';
        }
      } catch (err) { }
    }

    function closeProfileModal() {
      document.getElementById('profile-modal').classList.add('hidden');
    }

    async function saveProfile() {
      const resume = document.getElementById('profile-resume').value;
      const skills = document.getElementById('profile-skills').value;

      try {
        await fetch('/api/save-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ resume_text: resume, skills: skills })
        });
        closeProfileModal();
        updateProfileStatus(resume);
        showToast('‚úÖ Profile saved!');
      } catch (err) {
        showToast('‚ùå Failed to save', 'error');
      }
    }

    function updateProfileStatus(resumeText) {
      const el = document.getElementById('profile-status');
      if (resumeText && resumeText.length > 50) {
        el.innerHTML = `<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs"><i class="fas fa-check-circle mr-1"></i> Resume Loaded</span>`;
      } else {
        el.innerHTML = `<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs"><i class="fas fa-exclamation-circle mr-1"></i> No Resume</span>`;
      }
    }

    // --- Result Modal ---
    function showResult(title, content) {
      document.getElementById('result-title').textContent = title;
      document.getElementById('result-content').innerHTML = content;
      document.getElementById('result-modal').classList.remove('hidden');
    }

    function closeResultModal() {
      document.getElementById('result-modal').classList.add('hidden');
    }

    function copyResultToClipboard() {
      if (currentResultText) {
        navigator.clipboard.writeText(currentResultText);
        showToast('‚úÖ Copied!');
      }
    }

    // --- Utilities ---
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // --- Init ---
    document.addEventListener('DOMContentLoaded', async () => {
      loadJobs();
      try {
        const res = await fetch('/api/get-profile');
        const data = await res.json();
        updateProfileStatus(data.resume_text);
      } catch (e) { }
    });
  </script>

</body>

</html>